<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-blue': '#1e3a8a',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-white font-sans antialiased">
    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar Navigation -->
        <aside class="w-20 bg-brand-blue flex flex-col items-center py-6 space-y-8">
            <div class="text-white font-bold text-2xl mb-4">L</div>

            <!-- Dashboard Icon -->
            <button onclick="showSection('dashboard')" class="nav-btn group relative flex items-center justify-center w-12 h-12 rounded-lg bg-white/10 hover:bg-white/20 transition-colors" data-section="dashboard">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                <span class="absolute left-full ml-3 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Dashboard</span>
            </button>

            <!-- Orders Icon -->
            <button onclick="showSection('orders')" class="nav-btn group relative flex items-center justify-center w-12 h-12 rounded-lg hover:bg-white/20 transition-colors" data-section="orders">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span class="absolute left-full ml-3 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Orders</span>
            </button>

            <!-- Shipments Icon -->
            <button onclick="showSection('shipments')" class="nav-btn group relative flex items-center justify-center w-12 h-12 rounded-lg hover:bg-white/20 transition-colors" data-section="shipments">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                </svg>
                <span class="absolute left-full ml-3 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Shipments</span>
            </button>

            <!-- Rate Calculator Link (Bottom) -->
            <div class="flex-grow"></div>
            <button onclick="showSection('dashboard')" class="group relative flex items-center justify-center w-12 h-12 rounded-lg bg-green-500 hover:bg-green-600 transition-colors">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                </svg>
                <span class="absolute left-full ml-3 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Rate Calculator</span>
            </button>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">

            <!-- Top Navigation Bar -->
            <header class="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                <div class="flex items-center flex-1 max-w-2xl">
                    <h1 class="text-2xl font-bold text-slate-800" id="page-title">Dashboard</h1>
                </div>

                <div class="flex items-center space-x-4 ml-6">
                    <button onclick="showCreateOrderModal()" class="bg-brand-blue text-white px-5 py-2 rounded-lg hover:bg-blue-900 transition-colors font-medium flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span>Create New Order</span>
                    </button>
                </div>
            </header>

            <!-- Main Content Sections -->
            <main class="flex-1 overflow-y-auto p-6">

                <!-- Dashboard Section -->
                <div id="section-dashboard" class="content-section">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Stats Cards -->
                        <div class="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
                            <h3 class="text-sm font-medium text-slate-600 mb-2">Total Orders</h3>
                            <div class="text-3xl font-bold text-slate-800" id="stat-total-orders">0</div>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
                            <h3 class="text-sm font-medium text-slate-600 mb-2">Pending Orders</h3>
                            <div class="text-3xl font-bold text-orange-600" id="stat-pending-orders">0</div>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
                            <h3 class="text-sm font-medium text-slate-600 mb-2">Booked Orders</h3>
                            <div class="text-3xl font-bold text-green-600" id="stat-booked-orders">0</div>
                        </div>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-slate-800 mb-4">Recent Orders</h2>
                        <div id="recent-orders-list"></div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="section-orders" class="content-section hidden">
                    <div class="mb-6 flex items-center justify-between">
                        <div class="flex space-x-2 bg-slate-100 rounded-lg p-1 inline-flex">
                            <button onclick="filterOrders('all')" class="order-filter-btn px-4 py-2 text-sm font-medium rounded-md bg-white text-brand-blue shadow-sm" data-filter="all">All Orders</button>
                            <button onclick="filterOrders('draft')" class="order-filter-btn px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800" data-filter="draft">Draft</button>
                            <button onclick="filterOrders('pending')" class="order-filter-btn px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800" data-filter="pending">Pending</button>
                            <button onclick="filterOrders('booked')" class="order-filter-btn px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800" data-filter="booked">Booked</button>
                        </div>

                        <!-- Action Buttons (shown when orders selected) -->
                        <div id="order-actions" class="hidden space-x-2">
                            <span id="selected-count" class="text-sm text-slate-600 mr-2"></span>
                            <button onclick="editSelectedOrder()" id="edit-btn" class="hidden px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">Edit</button>
                            <button onclick="cancelSelectedOrders()" id="cancel-btn" class="hidden px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 transition-colors">Cancel Booking</button>
                            <button onclick="deleteSelectedOrders()" id="delete-btn" class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors">Delete</button>
                        </div>
                    </div>

                    <div id="orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- Shipments Section -->
                <div id="section-shipments" class="content-section hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Left: Orders Selection -->
                        <div>
                            <h2 class="text-xl font-semibold text-slate-800 mb-4">Select Orders to Ship</h2>
                            <div id="shipment-orders-list" class="space-y-3"></div>
                        </div>

                        <!-- Right: Carrier Comparison -->
                        <div>
                            <div class="bg-white border border-slate-200 rounded-lg overflow-hidden">
                                <div class="bg-gradient-to-r from-brand-blue to-blue-900 px-4 py-3">
                                    <h3 class="text-sm font-semibold text-white flex items-center">
                                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                        </svg>
                                        Carrier Comparison
                                    </h3>
                                    <p class="text-xs text-blue-100 mt-1">Select orders first, then compare rates</p>
                                </div>

                                <div id="carrier-comparison" class="p-4">
                                    <div class="text-center py-12 text-slate-500">
                                        <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                                        </svg>
                                        <p>Select orders to compare carrier rates</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Create Order Modal -->
    <div id="createOrderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
                <h2 class="text-xl font-bold text-slate-800">Create New Order</h2>
                <button onclick="hideCreateOrderModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>

            <form id="createOrderForm" class="p-6 space-y-6">
                <!-- Recipient Details -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Recipient Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Name *</label>
                            <input type="text" name="recipient_name" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onblur="validateName(this)" oninput="clearError(this); this.value = this.value.replace(/[^a-zA-Z\s.-]/g, '')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Contact Number *</label>
                            <input type="tel" name="recipient_contact" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onblur="validateContact(this)" oninput="clearError(this); this.value = this.value.replace(/\D/g, '')" maxlength="10">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Address *</label>
                            <textarea name="recipient_address" required rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onblur="validateAddress(this)" oninput="clearError(this)"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Pincode *</label>
                            <input type="text" id="recipient_pincode" name="recipient_pincode" required maxlength="6" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onchange="lookupPincode('recipient')" onblur="validatePincode(this)" oninput="clearError(this); this.value = this.value.replace(/\D/g, '')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">City</label>
                            <input type="text" id="recipient_city" name="recipient_city" readonly class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-50 text-slate-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">State</label>
                            <input type="text" id="recipient_state" name="recipient_state" readonly class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-50 text-slate-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                            <input type="email" name="recipient_email" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onblur="validateEmail(this)" oninput="clearError(this)">
                        </div>
                    </div>
                </div>

                <!-- Sender Details -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Sender Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Sender Pincode *</label>
                            <input type="text" name="sender_pincode" required maxlength="6" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onblur="validatePincode(this)" oninput="clearError(this); this.value = this.value.replace(/\D/g, '')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Sender Name</label>
                            <input type="text" name="sender_name" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onblur="validateName(this)" oninput="clearError(this); this.value = this.value.replace(/[^a-zA-Z\s.-]/g, '')">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Sender Address</label>
                            <textarea name="sender_address" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onblur="validateAddress(this)" oninput="clearError(this)"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Sender Phone</label>
                            <input type="tel" name="sender_phone" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onblur="validatePhone(this)" oninput="clearError(this); this.value = this.value.replace(/\D/g, '')" maxlength="10">
                        </div>
                    </div>
                </div>

                <!-- Box Details -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Box Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Actual Weight (kg) *</label>
                            <input type="number" id="weight" name="weight" required step="0.01" min="0.01" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onchange="calculateWeights()" onblur="validateNumeric(this, 'Weight')" oninput="clearError(this)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Length (cm) *</label>
                            <input type="number" id="length" name="length" required step="0.1" min="0.1" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onchange="calculateWeights()" onblur="validateNumeric(this, 'Length')" oninput="clearError(this)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Width (cm) *</label>
                            <input type="number" id="width" name="width" required step="0.1" min="0.1" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onchange="calculateWeights()" onblur="validateNumeric(this, 'Width')" oninput="clearError(this)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Height (cm) *</label>
                            <input type="number" id="height" name="height" required step="0.1" min="0.1" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent" onchange="calculateWeights()" onblur="validateNumeric(this, 'Height')" oninput="clearError(this)">
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="text-slate-600">Volumetric Weight:</span>
                                <span class="ml-1 font-bold text-brand-blue" id="volumetric_weight_display">0.00 kg</span>
                            </div>
                            <div>
                                <span class="text-slate-600">Applicable Weight:</span>
                                <span class="ml-1 font-bold text-green-600" id="applicable_weight_display">0.00 kg</span>
                            </div>
                            <div class="text-xs text-slate-500 italic">
                                Volumetric = (L × W × H) ÷ 5000<br>
                                Applicable = max(Actual, Volumetric)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment & Items -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Payment & Items</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Payment Mode *</label>
                            <select name="payment_mode" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                                <option value="prepaid">Prepaid</option>
                                <option value="cod">Cash on Delivery (COD)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Order Value (₹)</label>
                            <input type="number" name="order_value" step="0.01" min="0" value="0" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Item Type</label>
                            <input type="text" name="item_type" placeholder="e.g., Electronics, Clothing" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">SKU</label>
                            <input type="text" name="sku" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Quantity</label>
                            <input type="number" name="quantity" min="1" value="1" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Item Amount (₹)</label>
                            <input type="number" name="item_amount" step="0.01" min="0" value="0" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
                    <textarea name="notes" rows="2" class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"></textarea>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="hideCreateOrderModal()" class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">
                        Cancel
                    </button>
                    <button type="submit" class="px-6 py-2 bg-brand-blue text-white rounded-lg hover:bg-blue-900">
                        Create Order
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let selectedOrdersForShipment = [];

        // Pincode Lookup Function
        async function lookupPincode(type) {
            const pincodeInput = document.getElementById(`${type}_pincode`);
            const pincode = pincodeInput.value;

            if (!pincode || pincode.length !== 6) {
                document.getElementById(`${type}_city`).value = '';
                document.getElementById(`${type}_state`).value = '';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/pincode/${pincode}/`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById(`${type}_city`).value = data.city;
                    document.getElementById(`${type}_state`).value = data.state;
                } else {
                    document.getElementById(`${type}_city`).value = 'Invalid pincode';
                    document.getElementById(`${type}_state`).value = 'Invalid pincode';
                }
            } catch (error) {
                console.error('Failed to lookup pincode', error);
                document.getElementById(`${type}_city`).value = 'Error';
                document.getElementById(`${type}_state`).value = 'Error';
            }
        }

        // Weight Calculation Function
        function calculateWeights() {
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const length = parseFloat(document.getElementById('length').value) || 0;
            const width = parseFloat(document.getElementById('width').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;

            // Calculate volumetric weight: (L × W × H) ÷ 5000
            const volumetricWeight = (length * width * height) / 5000;

            // Applicable weight is max of actual and volumetric
            const applicableWeight = Math.max(weight, volumetricWeight);

            // Display results
            document.getElementById('volumetric_weight_display').textContent = volumetricWeight.toFixed(2) + ' kg';
            document.getElementById('applicable_weight_display').textContent = applicableWeight.toFixed(2) + ' kg';
        }

        // Validation Functions
        function showError(inputElement, message) {
            inputElement.classList.add('border-red-500', 'border-2');
            inputElement.classList.remove('border-slate-300');

            // Remove existing error message
            const existingError = inputElement.parentElement.querySelector('.error-message');
            if (existingError) existingError.remove();

            // Add error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message text-red-600 text-xs mt-1';
            errorDiv.textContent = message;
            inputElement.parentElement.appendChild(errorDiv);
        }

        function clearError(inputElement) {
            inputElement.classList.remove('border-red-500', 'border-2');
            inputElement.classList.add('border-slate-300');

            const errorMsg = inputElement.parentElement.querySelector('.error-message');
            if (errorMsg) errorMsg.remove();
        }

        function validateName(input) {
            const value = input.value.trim();
            if (!value) {
                clearError(input);
                return true;
            }

            const nameRegex = /^[a-zA-Z\s.-]+$/;
            if (!nameRegex.test(value)) {
                showError(input, 'Name must contain only letters, spaces, dots, and hyphens');
                return false;
            }
            clearError(input);
            return true;
        }

        function validateContact(input) {
            const value = input.value.replace(/[\s-]/g, '');

            if (!/^\d+$/.test(value)) {
                showError(input, 'Contact number must contain only digits');
                return false;
            }
            if (value.length !== 10) {
                showError(input, 'Contact number must be exactly 10 digits');
                return false;
            }
            clearError(input);
            return true;
        }

        function validatePhone(input) {
            const value = input.value.replace(/[\s-]/g, '');
            if (!value) {
                clearError(input);
                return true;
            }

            if (!/^\d+$/.test(value)) {
                showError(input, 'Phone number must contain only digits');
                return false;
            }
            if (value.length !== 10) {
                showError(input, 'Phone number must be exactly 10 digits');
                return false;
            }
            clearError(input);
            return true;
        }

        function validatePincode(input) {
            const value = input.value;

            if (!/^\d{6}$/.test(value)) {
                showError(input, 'Pincode must be exactly 6 digits');
                return false;
            }
            clearError(input);
            return true;
        }

        function validateEmail(input) {
            const value = input.value.trim();
            if (!value) {
                clearError(input);
                return true;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                showError(input, 'Invalid email format');
                return false;
            }
            clearError(input);
            return true;
        }

        function validateAddress(input) {
            const value = input.value.trim();
            if (!value) {
                clearError(input);
                return true;
            }

            const addressRegex = /^[a-zA-Z0-9\s.,/\-#()]+$/;
            if (!addressRegex.test(value)) {
                showError(input, 'Address contains invalid characters');
                return false;
            }
            clearError(input);
            return true;
        }

        function validateNumeric(input, fieldName) {
            const value = parseFloat(input.value);

            if (isNaN(value) || value <= 0) {
                showError(input, `${fieldName} must be a positive number`);
                return false;
            }
            clearError(input);
            return true;
        }

        // Section Navigation
        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-white/10');
                if (btn.dataset.section === section) {
                    btn.classList.add('bg-white/10');
                }
            });

            const titles = {
                dashboard: 'Dashboard',
                orders: 'Order Management',
                shipments: 'Shipment Management'
            };
            document.getElementById('page-title').textContent = titles[section] || 'Dashboard';

            if (section === 'dashboard') loadDashboard();
            if (section === 'orders') loadAllOrders();
            if (section === 'shipments') loadShipmentOrders();
        }

        // Modal Functions
        function showCreateOrderModal() {
            document.getElementById('createOrderModal').classList.remove('hidden');
        }

        function hideCreateOrderModal() {
            document.getElementById('createOrderModal').classList.add('hidden');

            const form = document.getElementById('createOrderForm');
            form.reset();

            // Clear edit mode
            delete form.dataset.editId;
            document.getElementById('modal-title').textContent = 'Create New Order';
            document.getElementById('submit-order-btn').textContent = 'Create Order';

            // Hide COD details
            document.getElementById('cod-details').classList.add('hidden');
        }

        // Create Order
        document.getElementById('createOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Clear all previous errors
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            document.querySelectorAll('.border-red-500').forEach(el => {
                el.classList.remove('border-red-500', 'border-2');
                el.classList.add('border-slate-300');
            });

            // Validate all fields before submission
            let isValid = true;
            const form = e.target;

            // Validate names
            const recipientName = form.querySelector('[name="recipient_name"]');
            if (!validateName(recipientName)) isValid = false;

            const senderName = form.querySelector('[name="sender_name"]');
            if (senderName.value && !validateName(senderName)) isValid = false;

            // Validate contacts
            const recipientContact = form.querySelector('[name="recipient_contact"]');
            if (!validateContact(recipientContact)) isValid = false;

            const senderPhone = form.querySelector('[name="sender_phone"]');
            if (senderPhone.value && !validatePhone(senderPhone)) isValid = false;

            // Validate addresses
            const recipientAddress = form.querySelector('[name="recipient_address"]');
            if (!validateAddress(recipientAddress)) isValid = false;

            const senderAddress = form.querySelector('[name="sender_address"]');
            if (senderAddress.value && !validateAddress(senderAddress)) isValid = false;

            // Validate pincodes
            const recipientPincode = form.querySelector('[name="recipient_pincode"]');
            if (!validatePincode(recipientPincode)) isValid = false;

            const senderPincode = form.querySelector('[name="sender_pincode"]');
            if (!validatePincode(senderPincode)) isValid = false;

            // Validate email
            const email = form.querySelector('[name="recipient_email"]');
            if (email.value && !validateEmail(email)) isValid = false;

            // Validate numeric fields
            if (!validateNumeric(form.querySelector('[name="weight"]'), 'Weight')) isValid = false;
            if (!validateNumeric(form.querySelector('[name="length"]'), 'Length')) isValid = false;
            if (!validateNumeric(form.querySelector('[name="width"]'), 'Width')) isValid = false;
            if (!validateNumeric(form.querySelector('[name="height"]'), 'Height')) isValid = false;

            if (!isValid) {
                // Scroll to first error
                const firstError = document.querySelector('.border-red-500');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }

            const formData = new FormData(e.target);
            const data = {};

            formData.forEach((value, key) => {
                if (value !== '') {
                    if (['recipient_pincode', 'sender_pincode', 'quantity'].includes(key)) {
                        data[key] = parseInt(value);
                    } else if (['weight', 'length', 'width', 'height', 'order_value', 'item_amount'].includes(key)) {
                        data[key] = parseFloat(value);
                    } else {
                        data[key] = value;
                    }
                }
            });

            try {
                // Check if we're editing an existing order
                const editId = e.target.dataset.editId;
                const isEdit = editId !== undefined && editId !== '';

                const url = isEdit ? `${API_BASE}/api/orders/${editId}/` : `${API_BASE}/api/orders/`;
                const method = isEdit ? 'PATCH' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert(isEdit ? 'Order updated successfully!' : 'Order created successfully!');

                    // Clear edit mode
                    delete e.target.dataset.editId;
                    document.getElementById('modal-title').textContent = 'Create New Order';
                    document.getElementById('submit-order-btn').textContent = 'Create Order';

                    hideCreateOrderModal();
                    loadAllOrders();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    // Handle validation errors from backend
                    if (error.detail && Array.isArray(error.detail)) {
                        // Pydantic validation errors
                        error.detail.forEach(err => {
                            const fieldName = err.loc[err.loc.length - 1];
                            const input = form.querySelector(`[name="${fieldName}"]`);
                            if (input) {
                                showError(input, err.msg);
                            }
                        });
                        const firstError = document.querySelector('.border-red-500');
                        if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        alert(`Error: ${typeof error.detail === 'string' ? error.detail : JSON.stringify(error.detail)}`);
                    }
                }
            } catch (error) {
                alert('Failed to create order');
            }
        });

        // Load Dashboard
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/api/orders/`);
                const orders = await response.json();

                document.getElementById('stat-total-orders').textContent = orders.length;
                document.getElementById('stat-pending-orders').textContent = orders.filter(o => o.status === 'draft' || o.status === 'pending').length;
                document.getElementById('stat-booked-orders').textContent = orders.filter(o => o.status === 'booked').length;

                const recentOrders = orders.slice(0, 5);
                const recentOrdersHtml = recentOrders.map(order => `
                    <div class="border-b border-slate-200 py-3 flex items-center justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-slate-800">${order.order_number}</div>
                            <div class="text-sm text-slate-500">${order.recipient_name} - ${order.recipient_pincode}</div>
                        </div>
                        <div>
                            <span class="text-xs px-2 py-1 rounded-full ${getStatusColor(order.status)}">${order.status.toUpperCase()}</span>
                        </div>
                    </div>
                `).join('');

                document.getElementById('recent-orders-list').innerHTML = recentOrdersHtml || '<p class="text-slate-500 text-center py-4">No orders yet</p>';
            } catch (error) {
                console.error('Failed to load dashboard', error);
            }
        }

        // Load All Orders
        async function loadAllOrders(status = null) {
            try {
                const url = status && status !== 'all' ? `${API_BASE}/api/orders/?status=${status}` : `${API_BASE}/api/orders/`;
                const response = await fetch(url);
                const orders = await response.json();

                const ordersHtml = orders.map(order => `
                    <div class="bg-white border border-slate-200 rounded-lg p-4 hover:border-brand-blue transition-all relative">
                        <div class="absolute top-3 left-3">
                            <input type="checkbox" value="${order.id}" data-status="${order.status}" class="w-5 h-5 text-brand-blue border-slate-300 rounded focus:ring-brand-blue order-checkbox" onchange="handleOrderSelection()">
                        </div>
                        <div class="pl-8">
                            <div class="flex items-start justify-between mb-3">
                                <span class="text-sm font-medium text-slate-500">${order.order_number}</span>
                                <span class="text-xs px-2 py-1 rounded-full ${getStatusColor(order.status)}">${order.status.toUpperCase()}</span>
                            </div>
                            <h4 class="font-semibold text-slate-800 mb-2">${order.recipient_name}</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                                <div>
                                    <span class="text-slate-500">Pincode:</span>
                                    <span class="ml-1 font-medium text-slate-700">${order.recipient_pincode}</span>
                                </div>
                                <div>
                                    <span class="text-slate-500">Weight:</span>
                                    <span class="ml-1 font-medium text-slate-700">${order.applicable_weight || order.weight} kg</span>
                                </div>
                                <div class="col-span-2">
                                    <span class="text-slate-500">Payment:</span>
                                    <span class="ml-1 font-medium text-slate-700">${order.payment_mode.toUpperCase()}</span>
                                </div>
                            </div>
                            ${order.selected_carrier ? `
                                <div class="text-sm border-t border-slate-200 pt-2">
                                    <span class="text-slate-500">Carrier:</span>
                                    <span class="ml-1 font-medium text-brand-blue">${order.selected_carrier} (₹${order.total_cost})</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');

                document.getElementById('orders-list').innerHTML = ordersHtml || '<p class="text-slate-500 col-span-full text-center py-8">No orders found</p>';
            } catch (error) {
                console.error('Failed to load orders', error);
            }
        }

        // Filter Orders
        function filterOrders(status) {
            document.querySelectorAll('.order-filter-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-brand-blue', 'shadow-sm');
                btn.classList.add('text-slate-600');
                if (btn.dataset.filter === status) {
                    btn.classList.remove('text-slate-600');
                    btn.classList.add('bg-white', 'text-brand-blue', 'shadow-sm');
                }
            });
            loadAllOrders(status);
        }

        // Load Shipment Orders
        async function loadShipmentOrders() {
            try {
                const response = await fetch(`${API_BASE}/api/orders/?status=draft`);
                const draftOrders = await response.json();

                const ordersHtml = draftOrders.map(order => `
                    <div class="bg-white border border-slate-200 rounded-lg p-4 hover:border-brand-blue cursor-pointer transition-all">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" value="${order.id}" class="w-5 h-5 text-brand-blue border-slate-300 rounded focus:ring-brand-blue shipment-order-checkbox" onchange="handleShipmentOrderSelection()">
                            <div class="flex-1">
                                <div class="font-semibold text-slate-800">${order.order_number}</div>
                                <div class="text-sm text-slate-500">${order.recipient_name} - ${order.recipient_pincode}</div>
                                <div class="text-sm text-slate-600 mt-1">
                                    Weight: ${order.applicable_weight || order.weight} kg | ${order.payment_mode.toUpperCase()}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('shipment-orders-list').innerHTML = ordersHtml || '<p class="text-slate-500 text-center py-4">No draft orders available</p>';
            } catch (error) {
                console.error('Failed to load shipment orders', error);
            }
        }

        // Handle Shipment Order Selection
        async function handleShipmentOrderSelection() {
            const checkboxes = document.querySelectorAll('.shipment-order-checkbox:checked');
            selectedOrdersForShipment = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (selectedOrdersForShipment.length > 0) {
                await compareCarriersForShipment();
            } else {
                document.getElementById('carrier-comparison').innerHTML = `
                    <div class="text-center py-12 text-slate-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p>Select orders to compare carrier rates</p>
                    </div>
                `;
            }
        }

        // Compare Carriers for Shipment
        async function compareCarriersForShipment() {
            try {
                const response = await fetch(`${API_BASE}/api/orders/compare-carriers/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_ids: selectedOrdersForShipment })
                });

                const data = await response.json();

                const carriersHtml = data.carriers.map(carrier => `
                    <label class="flex items-center p-3 border-b border-slate-100 hover:bg-slate-50 cursor-pointer rounded-lg transition-colors">
                        <input type="radio" name="selected-carrier" value='${JSON.stringify({carrier: carrier.carrier, mode: carrier.mode})}' class="w-4 h-4 text-brand-blue border-slate-300 focus:ring-brand-blue">
                        <div class="ml-3 flex-1 flex items-center justify-between">
                            <div>
                                <div class="font-semibold text-slate-800">${carrier.carrier}</div>
                                <div class="text-xs text-slate-500">${carrier.mode} • ${carrier.applied_zone}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-slate-800">₹${carrier.total_cost.toFixed(2)}</div>
                            </div>
                        </div>
                    </label>
                `).join('');

                document.getElementById('carrier-comparison').innerHTML = `
                    <div class="mb-3">
                        <div class="text-sm text-slate-600 mb-2">
                            <strong>${data.orders.length}</strong> order(s) selected | Total Weight: <strong>${data.total_weight} kg</strong>
                        </div>
                    </div>
                    <div class="space-y-2 mb-4">
                        ${carriersHtml}
                    </div>
                    <button onclick="bookSelectedCarrier()" class="w-full bg-brand-blue text-white py-3 rounded-lg hover:bg-blue-900 transition-colors font-medium">
                        Book Selected Carrier
                    </button>
                `;
            } catch (error) {
                alert('Failed to compare carriers');
            }
        }

        // Book Selected Carrier
        async function bookSelectedCarrier() {
            const selected = document.querySelector('input[name="selected-carrier"]:checked');
            if (!selected) {
                alert('Please select a carrier');
                return;
            }

            const {carrier, mode} = JSON.parse(selected.value);

            try {
                const response = await fetch(`${API_BASE}/api/orders/book-carrier/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_ids: selectedOrdersForShipment,
                        carrier_name: carrier,
                        mode: mode
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Success! ${result.message}\nTotal Cost: ₹${result.total_cost}`);
                    selectedOrdersForShipment = [];
                    loadShipmentOrders();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (error) {
                alert('Failed to book carrier');
            }
        }

        // Order Selection Handling
        let selectedOrders = [];

        function handleOrderSelection() {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            selectedOrders = Array.from(checkboxes).map(cb => ({
                id: parseInt(cb.value),
                status: cb.dataset.status
            }));

            const actionsDiv = document.getElementById('order-actions');
            const selectedCount = document.getElementById('selected-count');
            const editBtn = document.getElementById('edit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const deleteBtn = document.getElementById('delete-btn');

            if (selectedOrders.length > 0) {
                actionsDiv.classList.remove('hidden');
                selectedCount.textContent = `${selectedOrders.length} selected`;

                // Show Edit only if exactly 1 order selected and it's DRAFT
                if (selectedOrders.length === 1 && selectedOrders[0].status === 'draft') {
                    editBtn.classList.remove('hidden');
                } else {
                    editBtn.classList.add('hidden');
                }

                // Show Cancel only if all selected orders are BOOKED
                const allBooked = selectedOrders.every(o => o.status === 'booked');
                if (allBooked) {
                    cancelBtn.classList.remove('hidden');
                } else {
                    cancelBtn.classList.add('hidden');
                }

                // Show Delete only if all selected orders are DRAFT
                const allDraft = selectedOrders.every(o => o.status === 'draft');
                if (allDraft) {
                    deleteBtn.classList.remove('hidden');
                } else {
                    deleteBtn.classList.add('hidden');
                }
            } else {
                actionsDiv.classList.add('hidden');
            }
        }

        async function editSelectedOrder() {
            if (selectedOrders.length !== 1) return;

            const orderId = selectedOrders[0].id;
            try {
                const response = await fetch(`${API_BASE}/api/orders/${orderId}/`);

                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error loading order: ${error.detail || 'Unknown error'}`);
                    return;
                }

                const order = await response.json();

                const form = document.getElementById('createOrderForm');

                // Populate the edit form with existing data using name selectors
                form.querySelector('[name="recipient_name"]').value = order.recipient_name || '';
                form.querySelector('[name="recipient_contact"]').value = order.recipient_contact || '';
                form.querySelector('[name="recipient_address"]').value = order.recipient_address || '';
                form.querySelector('[name="recipient_pincode"]').value = order.recipient_pincode || '';
                form.querySelector('[name="recipient_city"]').value = order.recipient_city || '';
                form.querySelector('[name="recipient_state"]').value = order.recipient_state || '';
                form.querySelector('[name="recipient_email"]').value = order.recipient_email || '';

                form.querySelector('[name="sender_pincode"]').value = order.sender_pincode || '';
                form.querySelector('[name="sender_name"]').value = order.sender_name || '';
                form.querySelector('[name="sender_address"]').value = order.sender_address || '';
                form.querySelector('[name="sender_phone"]').value = order.sender_phone || '';

                form.querySelector('[name="weight"]').value = order.weight || '';
                form.querySelector('[name="length"]').value = order.length || '';
                form.querySelector('[name="width"]').value = order.width || '';
                form.querySelector('[name="height"]').value = order.height || '';

                form.querySelector('[name="payment_mode"]').value = order.payment_mode || 'prepaid';
                form.querySelector('[name="order_value"]').value = order.order_value || '0';
                form.querySelector('[name="item_type"]').value = order.item_type || '';
                form.querySelector('[name="sku"]').value = order.sku || '';
                form.querySelector('[name="quantity"]').value = order.quantity || '1';
                form.querySelector('[name="item_amount"]').value = order.item_amount || '0';
                form.querySelector('[name="notes"]').value = order.notes || '';

                // Show COD details if applicable
                if (order.payment_mode === 'cod') {
                    document.getElementById('cod-details').classList.remove('hidden');
                }

                // Calculate and display weights
                calculateWeights();

                // Store order ID for update
                form.dataset.editId = orderId;
                document.getElementById('modal-title').textContent = 'Edit Order';
                document.getElementById('submit-order-btn').textContent = 'Update Order';

                showCreateOrderModal();
            } catch (error) {
                console.error('Edit error:', error);
                alert('Failed to load order details: ' + error.message);
            }
        }

        async function cancelSelectedOrders() {
            if (!confirm(`Are you sure you want to cancel ${selectedOrders.length} order(s)?`)) return;

            try {
                const promises = selectedOrders.map(order =>
                    fetch(`${API_BASE}/api/orders/${order.id}/cancel/`, { method: 'POST' })
                );

                await Promise.all(promises);
                alert('Orders cancelled successfully!');

                // Clear selection
                selectedOrders = [];
                loadAllOrders();
                loadDashboard();
            } catch (error) {
                alert('Failed to cancel orders');
            }
        }

        async function deleteSelectedOrders() {
            if (!confirm(`Are you sure you want to delete ${selectedOrders.length} order(s)? This cannot be undone.`)) return;

            try {
                const promises = selectedOrders.map(order =>
                    fetch(`${API_BASE}/api/orders/${order.id}/`, { method: 'DELETE' })
                );

                await Promise.all(promises);
                alert('Orders deleted successfully!');

                // Clear selection
                selectedOrders = [];
                loadAllOrders();
                loadDashboard();
            } catch (error) {
                alert('Failed to delete orders');
            }
        }

        // Helper Functions
        function getStatusColor(status) {
            const colors = {
                draft: 'bg-yellow-100 text-yellow-700',
                pending: 'bg-orange-100 text-orange-700',
                booked: 'bg-green-100 text-green-700',
                in_transit: 'bg-blue-100 text-blue-700',
                delivered: 'bg-purple-100 text-purple-700',
                cancelled: 'bg-red-100 text-red-700'
            };
            return colors[status] || 'bg-slate-100 text-slate-700';
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
        });
    </script>
</body>
</html>
