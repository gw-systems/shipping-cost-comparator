<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logistics Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-blue': '#1e3a8a',
                    },
                    animation: {
                        'slide-in': 'slideIn 0.3s ease-out',
                        'slide-out': 'slideOut 0.3s ease-in forwards',
                        'spin-slow': 'spin 1s linear infinite',
                    },
                    keyframes: {
                        slideIn: {
                            '0%': { transform: 'translateX(100%)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        slideOut: {
                            '0%': { transform: 'translateX(0)', opacity: '1' },
                            '100%': { transform: 'translateX(100%)', opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Loading Spinner */
        .spinner {
            border: 3px solid #e2e8f0;
            border-top: 3px solid #1e3a8a;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 0.8s linear infinite;
        }

        .spinner-lg {
            width: 48px;
            height: 48px;
            border-width: 4px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Skeleton Loader */
        .skeleton {
            background: linear-gradient(90deg, #e2e8f0 25%, #f1f5f9 50%, #e2e8f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Toast notification styles */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            pointer-events: auto;
            min-width: 300px;
            max-width: 450px;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: flex-start;
            gap: 12px;
            animation: slideIn 0.3s ease-out;
        }

        .toast.removing {
            animation: slideOut 0.3s ease-in forwards;
        }

        .toast-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .toast-error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .toast-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .toast-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .toast-close {
            margin-left: auto;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .toast-close:hover {
            opacity: 1;
        }
    </style>
</head>

<body class="bg-white font-sans antialiased">
    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <div class="flex h-screen overflow-hidden">

        <!-- Sidebar Navigation -->
        <aside class="w-20 bg-brand-blue flex flex-col items-center py-6 space-y-8">
            <div class="text-white font-bold text-2xl mb-4">L</div>

            <!-- Dashboard Icon -->
            <button onclick="showSection('dashboard')"
                class="nav-btn group relative flex items-center justify-center w-12 h-12 rounded-lg bg-white/10 hover:bg-white/20 transition-colors"
                data-section="dashboard">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6">
                    </path>
                </svg>
                <span
                    class="absolute left-full ml-3 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Dashboard</span>
            </button>

            <!-- Orders Icon -->
            <button onclick="showSection('orders')"
                class="nav-btn group relative flex items-center justify-center w-12 h-12 rounded-lg hover:bg-white/20 transition-colors"
                data-section="orders">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                    </path>
                </svg>
                <span
                    class="absolute left-full ml-3 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Orders</span>
            </button>

            <!-- Shipments Icon -->
            <button onclick="showSection('shipments')"
                class="nav-btn group relative flex items-center justify-center w-12 h-12 rounded-lg hover:bg-white/20 transition-colors"
                data-section="shipments">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                    </path>
                </svg>
                <span
                    class="absolute left-full ml-3 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Shipments</span>
            </button>

            <!-- FTL Icon -->
            <button onclick="showSection('ftl')"
                class="nav-btn group relative flex items-center justify-center w-12 h-12 rounded-lg hover:bg-white/20 transition-colors"
                data-section="ftl">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                </svg>
                <span
                    class="absolute left-full ml-3 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">FTL
                    Orders</span>
            </button>

            <!-- Rate Calculator Link (Bottom) -->
            <div class="flex-grow"></div>
            <button onclick="showSection('dashboard')"
                class="group relative flex items-center justify-center w-12 h-12 rounded-lg bg-green-500 hover:bg-green-600 transition-colors">
                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                    </path>
                </svg>
                <span
                    class="absolute left-full ml-3 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">Rate
                    Calculator</span>
            </button>
        </aside>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col overflow-hidden">

            <!-- Top Navigation Bar -->
            <header
                class="bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between sticky top-0 z-10">
                <div class="flex items-center flex-1 max-w-2xl">
                    <h1 class="text-2xl font-bold text-slate-800" id="page-title">Dashboard</h1>
                </div>

                <div class="flex items-center space-x-4 ml-6" id="header-actions">
                    <!-- Actions will be dynamically shown based on current section -->
                </div>
            </header>

            <!-- Main Content Sections -->
            <main class="flex-1 overflow-y-auto p-6">

                <!-- Dashboard Section -->
                <div id="section-dashboard" class="content-section">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <!-- Stats Cards -->
                        <div class="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
                            <h3 class="text-sm font-medium text-slate-600 mb-2">Total Orders</h3>
                            <div class="text-3xl font-bold text-slate-800" id="stat-total-orders">0</div>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
                            <h3 class="text-sm font-medium text-slate-600 mb-2">Pending Orders</h3>
                            <div class="text-3xl font-bold text-orange-600" id="stat-pending-orders">0</div>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-lg p-5 shadow-sm">
                            <h3 class="text-sm font-medium text-slate-600 mb-2">Booked Orders</h3>
                            <div class="text-3xl font-bold text-green-600" id="stat-booked-orders">0</div>
                        </div>
                    </div>

                    <div class="bg-white border border-slate-200 rounded-lg p-6">
                        <h2 class="text-xl font-semibold text-slate-800 mb-4">Recent Orders</h2>
                        <div id="recent-orders-list"></div>
                    </div>

                    <!-- Analytics Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
                        <div class="bg-white border border-slate-200 rounded-lg p-6">
                            <h2 class="text-lg font-semibold text-slate-800 mb-4">Orders by Status</h2>
                            <div class="relative h-64">
                                <canvas id="status-chart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white border border-slate-200 rounded-lg p-6">
                            <h2 class="text-lg font-semibold text-slate-800 mb-4">Order Activity</h2>
                            <div class="relative h-64">
                                <canvas id="orders-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Orders Section -->
                <div id="section-orders" class="content-section hidden">
                    <!-- Search and Filters Row -->
                    <div class="mb-6 space-y-4">
                        <!-- Search Bar -->
                        <div class="flex items-center gap-4">
                            <div class="flex-1 relative">
                                <input type="text" id="order-search"
                                    placeholder="Search by order #, name, pincode, or carrier..."
                                    class="w-full pl-10 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                    oninput="searchOrders(this.value)">
                                <svg class="w-5 h-5 text-slate-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none"
                                    stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <button onclick="exportOrdersCSV()"
                                class="px-4 py-2.5 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                    </path>
                                </svg>
                                Export CSV
                            </button>
                        </div>

                        <!-- Filter Buttons and Actions -->
                        <div class="flex items-center justify-between">
                            <div class="flex space-x-2 bg-slate-100 rounded-lg p-1 inline-flex">
                                <button onclick="filterOrders('all')"
                                    class="order-filter-btn px-4 py-2 text-sm font-medium rounded-md bg-white text-brand-blue shadow-sm"
                                    data-filter="all">All Orders</button>
                                <button onclick="filterOrders('draft')"
                                    class="order-filter-btn px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800"
                                    data-filter="draft">Draft</button>
                                <button onclick="filterOrders('booked')"
                                    class="order-filter-btn px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800"
                                    data-filter="booked">Booked</button>
                                <button onclick="filterOrders('cancelled')"
                                    class="order-filter-btn px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800"
                                    data-filter="cancelled">Cancelled</button>
                            </div>

                            <!-- Action Buttons (shown when orders selected) -->
                            <div id="order-actions" class="hidden flex items-center space-x-2">
                                <span id="selected-count" class="text-sm text-slate-600 mr-2"></span>
                                <button onclick="editSelectedOrder()" id="edit-btn"
                                    class="hidden px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">Edit</button>
                                <button onclick="cancelSelectedOrders()" id="cancel-btn"
                                    class="hidden px-4 py-2 bg-orange-600 text-white text-sm font-medium rounded-lg hover:bg-orange-700 transition-colors">Cancel
                                    Booking</button>
                                <button onclick="downloadSelectedInvoice()" id="invoice-btn"
                                    class="hidden px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-lg hover:bg-purple-700 transition-colors">Invoice</button>
                                <button onclick="showTrackingTimeline()" id="track-btn"
                                    class="hidden px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 transition-colors">Track</button>
                                <button onclick="deleteSelectedOrders()" id="delete-btn"
                                    class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors">Delete</button>
                            </div>
                        </div>
                    </div>

                    <div id="orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- FTL Section -->
                <div id="section-ftl" class="content-section hidden">
                    <div class="mb-6 flex items-center justify-between">
                        <div class="flex space-x-2 bg-slate-100 rounded-lg p-1 inline-flex">
                            <button onclick="filterFTLOrders('all')"
                                class="ftl-filter-btn px-4 py-2 text-sm font-medium rounded-md bg-white text-brand-blue shadow-sm"
                                data-filter="all">All Orders</button>
                            <button onclick="filterFTLOrders('draft')"
                                class="ftl-filter-btn px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800"
                                data-filter="draft">Draft</button>
                            <button onclick="filterFTLOrders('booked')"
                                class="ftl-filter-btn px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800"
                                data-filter="booked">Booked</button>
                            <button onclick="filterFTLOrders('cancelled')"
                                class="ftl-filter-btn px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800"
                                data-filter="cancelled">Cancelled</button>
                        </div>

                        <!-- FTL Action Buttons (shown when FTL orders selected) -->
                        <div id="ftl-order-actions" class="hidden flex items-center space-x-2">
                            <span id="ftl-selected-count" class="text-sm text-slate-600 mr-2"></span>
                            <button onclick="editSelectedFTLOrder()" id="ftl-edit-btn"
                                class="hidden px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">Edit</button>
                            <button onclick="deleteSelectedFTLOrders()" id="ftl-delete-btn"
                                class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors">Delete</button>
                        </div>
                    </div>

                    <div id="ftl-orders-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- Shipments Section -->
                <div id="section-shipments" class="content-section hidden">
                    <!-- Tab switcher for Regular and FTL -->
                    <div class="mb-6 flex space-x-2 bg-slate-100 rounded-lg p-1 inline-flex">
                        <button onclick="showShipmentTab('regular')"
                            class="shipment-tab-btn px-4 py-2 text-sm font-medium rounded-md bg-white text-brand-blue shadow-sm"
                            data-tab="regular">Regular Orders</button>
                        <button onclick="showShipmentTab('ftl')"
                            class="shipment-tab-btn px-4 py-2 text-sm font-medium rounded-md text-slate-600 hover:text-slate-800"
                            data-tab="ftl">FTL Orders</button>
                    </div>

                    <!-- Regular Orders Shipment Tab -->
                    <div id="shipment-regular-tab" class="shipment-tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Left: Orders Selection -->
                            <div>
                                <h2 class="text-xl font-semibold text-slate-800 mb-4">Select Orders to Ship</h2>
                                <div id="shipment-orders-list" class="space-y-3"></div>
                            </div>

                            <!-- Right: Carrier Comparison -->
                            <div>
                                <div class="bg-white border border-slate-200 rounded-lg overflow-hidden">
                                    <div class="bg-gradient-to-r from-brand-blue to-blue-900 px-4 py-3">
                                        <h3 class="text-sm font-semibold text-white flex items-center">
                                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor"
                                                viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z">
                                                </path>
                                            </svg>
                                            Carrier Comparison
                                        </h3>
                                        <p class="text-xs text-blue-100 mt-1">Select orders first, then compare rates
                                        </p>
                                    </div>

                                    <div id="carrier-comparison" class="p-4">
                                        <div class="text-center py-12 text-slate-500">
                                            <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none"
                                                stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                    d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                                                </path>
                                            </svg>
                                            <p>Select orders to compare carrier rates</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- FTL Orders Shipment Tab -->
                    <div id="shipment-ftl-tab" class="shipment-tab-content hidden">
                        <div class="bg-white border border-slate-200 rounded-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h2 class="text-xl font-semibold text-slate-800">FTL Orders</h2>
                                <!-- FTL Shipment Action Buttons -->
                                <div id="shipment-ftl-actions" class="hidden flex items-center space-x-2">
                                    <span id="shipment-ftl-selected-count" class="text-sm text-slate-600 mr-2"></span>
                                    <button onclick="bookSelectedFTLOrders()" id="shipment-ftl-book-btn"
                                        class="px-4 py-2 bg-green-600 text-white text-sm font-medium rounded-lg hover:bg-green-700 transition-colors">Book</button>
                                    <button onclick="editSelectedShipmentFTLOrder()" id="shipment-ftl-edit-btn"
                                        class="hidden px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 transition-colors">Edit</button>
                                    <button onclick="deleteSelectedShipmentFTLOrders()" id="shipment-ftl-delete-btn"
                                        class="px-4 py-2 bg-red-600 text-white text-sm font-medium rounded-lg hover:bg-red-700 transition-colors">Delete</button>
                                </div>
                            </div>
                            <div id="shipment-ftl-orders-list"
                                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Create Order Modal -->
    <div id="createOrderModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
                <h2 id="modal-title" class="text-xl font-bold text-slate-800">Create New Order</h2>
                <button onclick="hideCreateOrderModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <form id="createOrderForm" class="p-6 space-y-6">
                <!-- Recipient Details -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Recipient Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Name *</label>
                            <input type="text" name="recipient_name" required
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onblur="validateName(this)"
                                oninput="clearError(this); this.value = this.value.replace(/[^a-zA-Z\s.-]/g, '')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Contact Number *</label>
                            <input type="tel" name="recipient_contact" required
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onblur="validateContact(this)"
                                oninput="clearError(this); this.value = this.value.replace(/\D/g, '')" maxlength="10">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Address *</label>
                            <textarea name="recipient_address" required rows="2"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onblur="validateAddress(this)" oninput="clearError(this)"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Pincode *</label>
                            <input type="text" id="recipient_pincode" name="recipient_pincode" required maxlength="6"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onchange="lookupPincode('recipient')" onblur="validatePincode(this)"
                                oninput="clearError(this); this.value = this.value.replace(/\D/g, '')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">City</label>
                            <input type="text" id="recipient_city" name="recipient_city" readonly
                                class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-50 text-slate-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">State</label>
                            <input type="text" id="recipient_state" name="recipient_state" readonly
                                class="w-full px-3 py-2 border border-slate-200 rounded-lg bg-slate-50 text-slate-600">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                            <input type="email" name="recipient_email"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onblur="validateEmail(this)" oninput="clearError(this)">
                        </div>
                    </div>
                </div>

                <!-- Sender Details -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Sender Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Sender Pincode *</label>
                            <input type="text" name="sender_pincode" required maxlength="6"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onblur="validatePincode(this)"
                                oninput="clearError(this); this.value = this.value.replace(/\D/g, '')">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Sender Name</label>
                            <input type="text" name="sender_name"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onblur="validateName(this)"
                                oninput="clearError(this); this.value = this.value.replace(/[^a-zA-Z\s.-]/g, '')">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Sender Address</label>
                            <textarea name="sender_address" rows="2"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onblur="validateAddress(this)" oninput="clearError(this)"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Sender Phone</label>
                            <input type="tel" name="sender_phone"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onblur="validatePhone(this)"
                                oninput="clearError(this); this.value = this.value.replace(/\D/g, '')" maxlength="10">
                        </div>
                    </div>
                </div>

                <!-- Box Details -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Box Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Actual Weight (kg) *</label>
                            <input type="number" id="weight" name="weight" required step="0.01" min="0.01"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onchange="calculateWeights()" onblur="validateNumeric(this, 'Weight')"
                                oninput="clearError(this)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Length (cm) *</label>
                            <input type="number" id="length" name="length" required step="0.1" min="0.1"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onchange="calculateWeights()" onblur="validateNumeric(this, 'Length')"
                                oninput="clearError(this)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Width (cm) *</label>
                            <input type="number" id="width" name="width" required step="0.1" min="0.1"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onchange="calculateWeights()" onblur="validateNumeric(this, 'Width')"
                                oninput="clearError(this)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Height (cm) *</label>
                            <input type="number" id="height" name="height" required step="0.1" min="0.1"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onchange="calculateWeights()" onblur="validateNumeric(this, 'Height')"
                                oninput="clearError(this)">
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <div class="grid grid-cols-3 gap-4 text-sm">
                            <div>
                                <span class="text-slate-600">Volumetric Weight:</span>
                                <span class="ml-1 font-bold text-brand-blue" id="volumetric_weight_display">0.00
                                    kg</span>
                            </div>
                            <div>
                                <span class="text-slate-600">Applicable Weight:</span>
                                <span class="ml-1 font-bold text-green-600" id="applicable_weight_display">0.00
                                    kg</span>
                            </div>
                            <div class="text-xs text-slate-500 italic">
                                Volumetric = (L × W × H) ÷ 5000<br>
                                Applicable = max(Actual, Volumetric)
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payment & Items -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Payment & Items</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Payment Mode *</label>
                            <select name="payment_mode"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                                <option value="prepaid">Prepaid</option>
                                <option value="cod">Cash on Delivery (COD)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Order Value (₹)</label>
                            <input type="number" name="order_value" step="0.01" min="0" value="0"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Item Type</label>
                            <input type="text" name="item_type" placeholder="e.g., Electronics, Clothing"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">SKU</label>
                            <input type="text" name="sku"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Quantity</label>
                            <input type="number" name="quantity" min="1" value="1"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Item Amount (₹)</label>
                            <input type="number" name="item_amount" step="0.01" min="0" value="0"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
                    <textarea name="notes" rows="2"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"></textarea>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="hideCreateFTLModal()"
                        class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">
                        Cancel
                    </button>
                    <button type="submit" id="submit-ftl-btn"
                        class="px-6 py-2 bg-brand-blue text-white rounded-lg hover:bg-blue-900">
                        Create FTL Order
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tracking Timeline Modal -->
    <div id="trackingModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <div
                class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between z-10">
                <h2 class="text-xl font-bold text-slate-800">Order Tracking</h2>
                <button onclick="hideTrackingModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="p-6">
                <div class="mb-6 bg-slate-50 p-4 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm text-slate-500">Order #</span>
                        <span class="font-bold text-slate-800" id="track-order-number">...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-slate-500">Current Status</span>
                        <span class="text-sm font-medium px-2 py-1 rounded-full bg-slate-200"
                            id="track-order-status">...</span>
                    </div>
                </div>

                <!-- Timeline Container -->
                <div class="relative pl-8 border-l-2 border-slate-200 space-y-8" id="tracking-timeline">
                    <!-- Timeline items will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Timeline Styles */
        .timeline-item {
            position: relative;
        }

        .timeline-dot {
            position: absolute;
            left: -41px;
            /* Adjust based on padding/border */
            top: 0;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #e2e8f0;
            background: white;
            z-index: 10;
        }

        .timeline-dot.active {
            background: #10b981;
            /* Green */
            border-color: #10b981;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timeline-dot.current {
            background: #3b82f6;
            /* Blue */
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
        }

        .timeline-dot.error {
            background: #ef4444;
            /* Red */
            border-color: #ef4444;
        }

        .timeline-content h4 {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2px;
        }

        .timeline-content p {
            font-size: 0.875rem;
            color: #64748b;
        }
    </style>
    <label class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
    <textarea name="notes" rows="2"
        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"></textarea>
    </div>

    <!-- Submit Button -->
    <div class="flex justify-end space-x-3 pt-4 border-t border-slate-200">
        <button type="button" onclick="hideCreateOrderModal()"
            class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">
            Cancel
        </button>
        <button type="submit" id="submit-order-btn"
            class="px-6 py-2 bg-brand-blue text-white rounded-lg hover:bg-blue-900">
            Create Order
        </button>
    </div>
    </form>
    </div>
    </div>

    <!-- Create FTL Order Modal -->
    <div id="createFTLModal"
        class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b border-slate-200 px-6 py-4 flex items-center justify-between">
                <h2 id="ftl-modal-title" class="text-xl font-bold text-slate-800">Create FTL Order</h2>
                <button onclick="hideCreateFTLModal()" class="text-slate-400 hover:text-slate-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <form id="createFTLForm" class="p-6 space-y-6">
                <!-- Contact Details -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Contact Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Name *</label>
                            <input type="text" name="name" required
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Phone *</label>
                            <input type="tel" name="phone" required maxlength="10"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                oninput="this.value = this.value.replace(/\D/g, '')">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                            <input type="email" name="email"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                        </div>
                    </div>
                </div>

                <!-- Location Details -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Location Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Source City *</label>
                            <select name="source_city" id="ftl-source-city" required
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                onchange="updateFTLDestinations()">
                                <option value="">Select Source City</option>
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Source Pincode *</label>
                            <input type="text" name="source_pincode" required maxlength="6"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                oninput="this.value = this.value.replace(/\D/g, '')">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Source Address *</label>
                            <textarea name="source_address" required rows="2"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                placeholder="Enter complete pickup address"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Destination City *</label>
                            <select name="destination_city" id="ftl-destination-city" required
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent">
                                <option value="">Select Destination City</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Destination Pincode *</label>
                            <input type="text" name="destination_pincode" required maxlength="6"
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                                oninput="this.value = this.value.replace(/\D/g, '')">
                        </div>
                    </div>
                </div>

                <!-- Container Type -->
                <div>
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Container Details</h3>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Container Type *</label>
                        <select name="container_type" id="ftl-container-type" required
                            class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"
                            onchange="calculateFTLRate()">
                            <option value="">Select Container Type</option>
                            <option value="20FT">20FT</option>
                            <option value="32 FT SXL 7MT">32 FT SXL 7MT</option>
                            <option value="32 FT SXL 9MT">32 FT SXL 9MT</option>
                        </select>
                    </div>
                </div>

                <!-- Pricing Breakdown (Display Only) -->
                <div id="ftl-pricing-breakdown" class="hidden border-t pt-4">
                    <h3 class="text-lg font-semibold text-slate-800 mb-3">Pricing Breakdown</h3>
                    <div class="bg-blue-50 rounded-lg p-4 space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600">Base Price:</span>
                            <span class="font-medium" id="ftl-base-price">₹0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600">Escalation (15%):</span>
                            <span class="font-medium" id="ftl-escalation">₹0.00</span>
                        </div>
                        <div class="flex justify-between text-sm border-t border-blue-200 pt-2">
                            <span class="text-slate-700 font-medium">Price + Escalation:</span>
                            <span class="font-semibold" id="ftl-price-escalation">₹0.00</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-slate-600">GST (18%):</span>
                            <span class="font-medium" id="ftl-gst">₹0.00</span>
                        </div>
                        <div class="flex justify-between text-lg font-bold border-t border-blue-300 pt-2">
                            <span class="text-slate-800">Total Price:</span>
                            <span class="text-brand-blue" id="ftl-total-price">₹0.00</span>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Notes</label>
                    <textarea name="notes" rows="2"
                        class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-blue focus:border-transparent"></textarea>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-end space-x-3 pt-4 border-t border-slate-200">
                    <button type="button" onclick="hideCreateFTLModal()"
                        class="px-6 py-2 border border-slate-300 rounded-lg text-slate-700 hover:bg-slate-50">
                        Cancel
                    </button>
                    <button type="submit" id="submit-ftl-btn"
                        class="px-6 py-2 bg-brand-blue text-white rounded-lg hover:bg-blue-900">
                        Create FTL Order
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let selectedOrdersForShipment = [];
        let statusChart = null;
        let ordersChart = null;

        // ============================================================================
        // TOAST NOTIFICATIONS
        // ============================================================================
        function showToast(message, type = 'info', duration = 4000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            const icons = {
                success: '<svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                error: '<svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
                warning: '<svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',
                info: '<svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
            };

            toast.innerHTML = `
                ${icons[type] || icons.info}
                <div class="flex-1">
                    <p class="font-medium">${message}</p>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;

            container.appendChild(toast);

            // Auto remove after duration
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ============================================================================
        // LOADING STATES
        // ============================================================================
        function showLoading(elementId, message = 'Loading...') {
            const element = document.getElementById(elementId);
            if (element) {
                element.dataset.originalContent = element.innerHTML;
                element.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-12">
                        <div class="spinner spinner-lg mb-4"></div>
                        <p class="text-slate-500">${message}</p>
                    </div>
                `;
            }
        }

        function hideLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element && element.dataset.originalContent) {
                element.innerHTML = element.dataset.originalContent;
                delete element.dataset.originalContent;
            }
        }

        function renderSkeletonCards(elementId, count = 3) {
            const element = document.getElementById(elementId);
            if (element) {
                const skeletons = Array(count).fill(`
                    <div class="bg-white border border-slate-200 rounded-lg p-4">
                        <div class="skeleton h-4 w-24 rounded mb-3"></div>
                        <div class="skeleton h-5 w-40 rounded mb-2"></div>
                        <div class="skeleton h-3 w-32 rounded mb-2"></div>
                        <div class="skeleton h-3 w-28 rounded"></div>
                    </div>
                `).join('');
                element.innerHTML = skeletons;
            }
        }

        // Pincode Lookup Function
        async function lookupPincode(type) {
            const pincodeInput = document.getElementById(`${type}_pincode`);
            const pincode = pincodeInput.value;

            if (!pincode || pincode.length !== 6) {
                document.getElementById(`${type}_city`).value = '';
                document.getElementById(`${type}_state`).value = '';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/pincode/${pincode}/`);
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById(`${type}_city`).value = data.city;
                    document.getElementById(`${type}_state`).value = data.state;
                } else {
                    document.getElementById(`${type}_city`).value = 'Invalid pincode';
                    document.getElementById(`${type}_state`).value = 'Invalid pincode';
                }
            } catch (error) {
                console.error('Failed to lookup pincode', error);
                document.getElementById(`${type}_city`).value = 'Error';
                document.getElementById(`${type}_state`).value = 'Error';
            }
        }

        // Weight Calculation Function
        function calculateWeights() {
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const length = parseFloat(document.getElementById('length').value) || 0;
            const width = parseFloat(document.getElementById('width').value) || 0;
            const height = parseFloat(document.getElementById('height').value) || 0;

            // Calculate volumetric weight: (L × W × H) ÷ 5000
            const volumetricWeight = (length * width * height) / 5000;

            // Applicable weight is max of actual and volumetric
            const applicableWeight = Math.max(weight, volumetricWeight);

            // Display results
            document.getElementById('volumetric_weight_display').textContent = volumetricWeight.toFixed(2) + ' kg';
            document.getElementById('applicable_weight_display').textContent = applicableWeight.toFixed(2) + ' kg';
        }

        // Validation Functions
        function showError(inputElement, message) {
            inputElement.classList.add('border-red-500', 'border-2');
            inputElement.classList.remove('border-slate-300');

            // Remove existing error message
            const existingError = inputElement.parentElement.querySelector('.error-message');
            if (existingError) existingError.remove();

            // Add error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message text-red-600 text-xs mt-1';
            errorDiv.textContent = message;
            inputElement.parentElement.appendChild(errorDiv);
        }

        function clearError(inputElement) {
            inputElement.classList.remove('border-red-500', 'border-2');
            inputElement.classList.add('border-slate-300');

            const errorMsg = inputElement.parentElement.querySelector('.error-message');
            if (errorMsg) errorMsg.remove();
        }

        function validateName(input) {
            const value = input.value.trim();
            if (!value) {
                clearError(input);
                return true;
            }

            const nameRegex = /^[a-zA-Z\s.-]+$/;
            if (!nameRegex.test(value)) {
                showError(input, 'Name must contain only letters, spaces, dots, and hyphens');
                return false;
            }
            clearError(input);
            return true;
        }

        function validateContact(input) {
            const value = input.value.replace(/[\s-]/g, '');

            if (!/^\d+$/.test(value)) {
                showError(input, 'Contact number must contain only digits');
                return false;
            }
            if (value.length !== 10) {
                showError(input, 'Contact number must be exactly 10 digits');
                return false;
            }
            clearError(input);
            return true;
        }

        function validatePhone(input) {
            const value = input.value.replace(/[\s-]/g, '');
            if (!value) {
                clearError(input);
                return true;
            }

            if (!/^\d+$/.test(value)) {
                showError(input, 'Phone number must contain only digits');
                return false;
            }
            if (value.length !== 10) {
                showError(input, 'Phone number must be exactly 10 digits');
                return false;
            }
            clearError(input);
            return true;
        }

        function validatePincode(input) {
            const value = input.value;

            if (!/^\d{6}$/.test(value)) {
                showError(input, 'Pincode must be exactly 6 digits');
                return false;
            }
            clearError(input);
            return true;
        }

        function validateEmail(input) {
            const value = input.value.trim();
            if (!value) {
                clearError(input);
                return true;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(value)) {
                showError(input, 'Invalid email format');
                return false;
            }
            clearError(input);
            return true;
        }

        function validateAddress(input) {
            const value = input.value.trim();
            if (!value) {
                clearError(input);
                return true;
            }

            const addressRegex = /^[a-zA-Z0-9\s.,/\-#()]+$/;
            if (!addressRegex.test(value)) {
                showError(input, 'Address contains invalid characters');
                return false;
            }
            clearError(input);
            return true;
        }

        function validateNumeric(input, fieldName) {
            const value = parseFloat(input.value);

            if (isNaN(value) || value <= 0) {
                showError(input, `${fieldName} must be a positive number`);
                return false;
            }
            clearError(input);
            return true;
        }

        // Section Navigation
        function showSection(section) {
            document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`section-${section}`).classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-white/10');
                if (btn.dataset.section === section) {
                    btn.classList.add('bg-white/10');
                }
            });

            const titles = {
                dashboard: 'Dashboard',
                orders: 'Order Management',
                shipments: 'Shipment Management',
                ftl: 'FTL Orders'
            };
            document.getElementById('page-title').textContent = titles[section] || 'Dashboard';

            // Update header actions based on section
            const headerActions = document.getElementById('header-actions');
            if (section === 'orders') {
                headerActions.innerHTML = `
                    <button onclick="showCreateOrderModal()" class="bg-brand-blue text-white px-5 py-2 rounded-lg hover:bg-blue-900 transition-colors font-medium flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span>Create New Order</span>
                    </button>
                `;
            } else if (section === 'ftl') {
                headerActions.innerHTML = `
                    <button onclick="showCreateFTLModal()" class="bg-brand-blue text-white px-5 py-2 rounded-lg hover:bg-blue-900 transition-colors font-medium flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                        </svg>
                        <span>Create FTL Order</span>
                    </button>
                `;
            } else {
                headerActions.innerHTML = '';
            }

            if (section === 'dashboard') loadDashboard();
            if (section === 'orders') loadAllOrders();
            if (section === 'shipments') loadShipmentOrders();
            if (section === 'ftl') loadFTLOrders();
        }

        // Modal Functions
        function showCreateOrderModal() {
            document.getElementById('createOrderModal').classList.remove('hidden');
        }

        function hideCreateOrderModal() {
            document.getElementById('createOrderModal').classList.add('hidden');

            const form = document.getElementById('createOrderForm');
            form.reset();

            // Clear edit mode
            delete form.dataset.editId;
            document.getElementById('modal-title').textContent = 'Create New Order';
            document.getElementById('submit-order-btn').textContent = 'Create Order';

            // Hide COD details (if element exists)
            const codDetails = document.getElementById('cod-details');
            if (codDetails) codDetails.classList.add('hidden');
        }

        // Create Order
        document.getElementById('createOrderForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Clear all previous errors
            document.querySelectorAll('.error-message').forEach(el => el.remove());
            document.querySelectorAll('.border-red-500').forEach(el => {
                el.classList.remove('border-red-500', 'border-2');
                el.classList.add('border-slate-300');
            });

            // Validate all fields before submission
            let isValid = true;
            const form = e.target;

            // Validate names
            const recipientName = form.querySelector('[name="recipient_name"]');
            if (!validateName(recipientName)) isValid = false;

            const senderName = form.querySelector('[name="sender_name"]');
            if (senderName.value && !validateName(senderName)) isValid = false;

            // Validate contacts
            const recipientContact = form.querySelector('[name="recipient_contact"]');
            if (!validateContact(recipientContact)) isValid = false;

            const senderPhone = form.querySelector('[name="sender_phone"]');
            if (senderPhone.value && !validatePhone(senderPhone)) isValid = false;

            // Validate addresses
            const recipientAddress = form.querySelector('[name="recipient_address"]');
            if (!validateAddress(recipientAddress)) isValid = false;

            const senderAddress = form.querySelector('[name="sender_address"]');
            if (senderAddress.value && !validateAddress(senderAddress)) isValid = false;

            // Validate pincodes
            const recipientPincode = form.querySelector('[name="recipient_pincode"]');
            if (!validatePincode(recipientPincode)) isValid = false;

            const senderPincode = form.querySelector('[name="sender_pincode"]');
            if (!validatePincode(senderPincode)) isValid = false;

            // Validate email
            const email = form.querySelector('[name="recipient_email"]');
            if (email.value && !validateEmail(email)) isValid = false;

            // Validate numeric fields
            if (!validateNumeric(form.querySelector('[name="weight"]'), 'Weight')) isValid = false;
            if (!validateNumeric(form.querySelector('[name="length"]'), 'Length')) isValid = false;
            if (!validateNumeric(form.querySelector('[name="width"]'), 'Width')) isValid = false;
            if (!validateNumeric(form.querySelector('[name="height"]'), 'Height')) isValid = false;

            if (!isValid) {
                // Scroll to first error
                const firstError = document.querySelector('.border-red-500');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                return;
            }

            const formData = new FormData(e.target);
            const data = {};

            formData.forEach((value, key) => {
                if (value !== '') {
                    if (['recipient_pincode', 'sender_pincode', 'quantity'].includes(key)) {
                        data[key] = parseInt(value);
                    } else if (['weight', 'length', 'width', 'height', 'order_value', 'item_amount'].includes(key)) {
                        data[key] = parseFloat(value);
                    } else {
                        data[key] = value;
                    }
                }
            });

            try {
                // Check if we're editing an existing order
                const editId = e.target.dataset.editId;
                const isEdit = editId !== undefined && editId !== '';

                const url = isEdit ? `${API_BASE}/api/orders/${editId}/` : `${API_BASE}/api/orders/`;
                const method = isEdit ? 'PATCH' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert(isEdit ? 'Order updated successfully!' : 'Order created successfully!');

                    // Clear edit mode
                    delete e.target.dataset.editId;
                    const modalTitle = document.getElementById('modal-title');
                    const submitBtn = document.getElementById('submit-order-btn');
                    if (modalTitle) modalTitle.textContent = 'Create New Order';
                    if (submitBtn) submitBtn.textContent = 'Create Order';

                    hideCreateOrderModal();

                    // Reload data - wrap in try-catch to prevent errors from showing failure message
                    try {
                        await loadAllOrders();
                        await loadDashboard();
                    } catch (reloadError) {
                        console.error('Error reloading data:', reloadError);
                        // Silently handle reload errors - order was still created successfully
                    }
                } else {
                    const error = await response.json();
                    // Handle validation errors from backend
                    if (error.detail && Array.isArray(error.detail)) {
                        // Pydantic validation errors
                        error.detail.forEach(err => {
                            const fieldName = err.loc[err.loc.length - 1];
                            const input = form.querySelector(`[name="${fieldName}"]`);
                            if (input) {
                                showError(input, err.msg);
                            }
                        });
                        const firstError = document.querySelector('.border-red-500');
                        if (firstError) firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    } else {
                        alert(`Error: ${typeof error.detail === 'string' ? error.detail : JSON.stringify(error.detail)}`);
                    }
                }
            } catch (error) {
                console.error('Order creation error:', error);
                alert('Failed to create order: ' + (error.message || 'Unknown error'));
            }
        });

        // Load Dashboard
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/api/orders/`);
                const data = await response.json();
                // Handle both array and paginated response formats
                const orders = Array.isArray(data) ? data : (data.results || []);

                // Update stats
                const draftCount = orders.filter(o => o.status === 'draft').length;
                const bookedCount = orders.filter(o => o.status === 'booked').length;
                const cancelledCount = orders.filter(o => o.status === 'cancelled').length;
                const deliveredCount = orders.filter(o => o.status === 'delivered').length;
                const otherCount = orders.length - draftCount - bookedCount - cancelledCount - deliveredCount;

                document.getElementById('stat-total-orders').textContent = orders.length;
                document.getElementById('stat-pending-orders').textContent = draftCount;
                document.getElementById('stat-booked-orders').textContent = bookedCount;

                // Render recent orders
                const recentOrders = orders.slice(0, 5);
                const recentOrdersHtml = recentOrders.map(order => `
                    <div class="border-b border-slate-200 py-3 flex items-center justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-slate-800">${order.order_number}</div>
                            <div class="text-sm text-slate-500">${order.recipient_name} - ${order.recipient_pincode}</div>
                        </div>
                        <div>
                            <span class="text-xs px-2 py-1 rounded-full ${getStatusColor(order.status)}">${order.status.toUpperCase()}</span>
                        </div>
                    </div>
                `).join('');

                document.getElementById('recent-orders-list').innerHTML = recentOrdersHtml || '<p class="text-slate-500 text-center py-4">No orders yet</p>';

                // Render Status Pie Chart
                const statusCtx = document.getElementById('status-chart');
                if (statusCtx) {
                    if (statusChart) statusChart.destroy();
                    statusChart = new Chart(statusCtx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Draft', 'Booked', 'Cancelled', 'Delivered', 'Other'],
                            datasets: [{
                                data: [draftCount, bookedCount, cancelledCount, deliveredCount, otherCount],
                                backgroundColor: [
                                    '#f59e0b', // Draft - yellow
                                    '#10b981', // Booked - green
                                    '#ef4444', // Cancelled - red
                                    '#3b82f6', // Delivered - blue
                                    '#6b7280', // Other - gray
                                ],
                                borderWidth: 0,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true,
                                    }
                                }
                            }
                        }
                    });
                }

                // Render Carrier Performance Bar Chart
                const carrierCounts = {};
                orders.forEach(order => {
                    if (order.selected_carrier) {
                        carrierCounts[order.selected_carrier] = (carrierCounts[order.selected_carrier] || 0) + 1;
                    }
                });

                const ordersCtx = document.getElementById('orders-chart');
                if (ordersCtx) {
                    if (ordersChart) ordersChart.destroy();

                    const carrierLabels = Object.keys(carrierCounts).slice(0, 5);
                    const carrierData = carrierLabels.map(c => carrierCounts[c]);

                    ordersChart = new Chart(ordersCtx, {
                        type: 'bar',
                        data: {
                            labels: carrierLabels.length ? carrierLabels : ['No carriers yet'],
                            datasets: [{
                                label: 'Orders by Carrier',
                                data: carrierLabels.length ? carrierData : [0],
                                backgroundColor: '#1e3a8a',
                                borderRadius: 6,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        stepSize: 1
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to load dashboard', error);
                showToast('Failed to load dashboard data', 'error');
            }
        }

        // Load All Orders
        async function loadAllOrders(status = null) {
            try {
                const url = status && status !== 'all' ? `${API_BASE}/api/orders/?status=${status}` : `${API_BASE}/api/orders/`;
                const response = await fetch(url);
                const data = await response.json();
                // Handle both array and paginated response formats
                const orders = Array.isArray(data) ? data : (data.results || []);

                const ordersHtml = orders.map(order => `
                    <div class="bg-white border border-slate-200 rounded-lg p-4 hover:border-brand-blue transition-all relative">
                        <div class="absolute top-3 left-3">
                            <input type="checkbox" value="${order.id}" data-status="${order.status}" class="w-5 h-5 text-brand-blue border-slate-300 rounded focus:ring-brand-blue order-checkbox" onchange="handleOrderSelection()">
                        </div>
                        <div class="pl-8">
                            <div class="flex items-start justify-between mb-3">
                                <span class="text-sm font-medium text-slate-500">${order.order_number}</span>
                                <span class="text-xs px-2 py-1 rounded-full ${getStatusColor(order.status)}">${order.status.toUpperCase()}</span>
                            </div>
                            <h4 class="font-semibold text-slate-800 mb-2">${order.recipient_name}</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                                <div>
                                    <span class="text-slate-500">Pincode:</span>
                                    <span class="ml-1 font-medium text-slate-700">${order.recipient_pincode}</span>
                                </div>
                                <div>
                                    <span class="text-slate-500">Weight:</span>
                                    <span class="ml-1 font-medium text-slate-700">${order.applicable_weight || order.weight} kg</span>
                                </div>
                                <div class="col-span-2">
                                    <span class="text-slate-500">Payment:</span>
                                    <span class="ml-1 font-medium text-slate-700">${order.payment_mode.toUpperCase()}</span>
                                </div>
                            </div>
                            ${order.selected_carrier ? `
                                <div class="text-sm border-t border-slate-200 pt-2">
                                    <span class="text-slate-500">Carrier:</span>
                                    <span class="ml-1 font-medium text-brand-blue">${order.selected_carrier} (₹${order.total_cost})</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');

                document.getElementById('orders-list').innerHTML = ordersHtml || '<p class="text-slate-500 col-span-full text-center py-8">No orders found</p>';
            } catch (error) {
                console.error('Failed to load orders', error);
            }
        }

        // Filter Orders
        function filterOrders(status) {
            document.querySelectorAll('.order-filter-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-brand-blue', 'shadow-sm');
                btn.classList.add('text-slate-600');
                if (btn.dataset.filter === status) {
                    btn.classList.remove('text-slate-600');
                    btn.classList.add('bg-white', 'text-brand-blue', 'shadow-sm');
                }
            });
            // Clear search when filter changes
            document.getElementById('order-search').value = '';
            loadAllOrders(status);
        }

        // Search Orders (client-side filtering with debounce)
        let searchTimeout = null;
        let allOrdersCache = [];

        async function searchOrders(query) {
            // Debounce - wait 300ms before searching
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(async () => {
                if (!query.trim()) {
                    // Empty search - reload all orders
                    loadAllOrders();
                    return;
                }

                // If cache is empty, fetch all orders first
                if (allOrdersCache.length === 0) {
                    const response = await fetch(`${API_BASE}/api/orders/`);
                    const data = await response.json();
                    allOrdersCache = Array.isArray(data) ? data : (data.results || []);
                }

                const searchTerm = query.toLowerCase();
                const filteredOrders = allOrdersCache.filter(order =>
                    order.order_number?.toLowerCase().includes(searchTerm) ||
                    order.recipient_name?.toLowerCase().includes(searchTerm) ||
                    order.recipient_pincode?.toString().includes(searchTerm) ||
                    order.selected_carrier?.toLowerCase().includes(searchTerm) ||
                    order.sender_name?.toLowerCase().includes(searchTerm) ||
                    order.status?.toLowerCase().includes(searchTerm)
                );

                renderOrdersList(filteredOrders);
            }, 300);
        }

        // Render orders list (extracted for reuse)
        function renderOrdersList(orders) {
            const ordersHtml = orders.map(order => `
                <div class="bg-white border border-slate-200 rounded-lg p-4 hover:border-brand-blue transition-all relative">
                    <div class="absolute top-3 left-3">
                        <input type="checkbox" value="${order.id}" data-status="${order.status}" class="w-5 h-5 text-brand-blue border-slate-300 rounded focus:ring-brand-blue order-checkbox" onchange="handleOrderSelection()">
                    </div>
                    <div class="pl-8">
                        <div class="flex items-start justify-between mb-3">
                            <span class="text-sm font-medium text-slate-500">${order.order_number}</span>
                            <span class="text-xs px-2 py-1 rounded-full ${getStatusColor(order.status)}">${order.status.toUpperCase()}</span>
                        </div>
                        <h4 class="font-semibold text-slate-800 mb-2">${order.recipient_name}</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                            <div>
                                <span class="text-slate-500">Pincode:</span>
                                <span class="ml-1 font-medium text-slate-700">${order.recipient_pincode}</span>
                            </div>
                            <div>
                                <span class="text-slate-500">Weight:</span>
                                <span class="ml-1 font-medium text-slate-700">${order.applicable_weight || order.weight} kg</span>
                            </div>
                            <div class="col-span-2">
                                <span class="text-slate-500">Payment:</span>
                                <span class="ml-1 font-medium text-slate-700">${order.payment_mode.toUpperCase()}</span>
                            </div>
                        </div>
                        ${order.selected_carrier ? `
                            <div class="text-sm border-t border-slate-200 pt-2">
                                <span class="text-slate-500">Carrier:</span>
                                <span class="ml-1 font-medium text-brand-blue">${order.selected_carrier} (₹${order.total_cost})</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            document.getElementById('orders-list').innerHTML = ordersHtml || '<p class="text-slate-500 col-span-full text-center py-8">No orders found</p>';
        }

        // Export Orders to CSV
        async function exportOrdersCSV() {
            try {
                showToast('Preparing CSV export...', 'info');

                // Fetch all orders
                const response = await fetch(`${API_BASE}/api/orders/`);
                const data = await response.json();
                const orders = Array.isArray(data) ? data : (data.results || []);

                if (orders.length === 0) {
                    showToast('No orders to export', 'warning');
                    return;
                }

                // Define CSV headers
                const headers = [
                    'Order Number', 'Status', 'Recipient Name', 'Recipient Contact',
                    'Recipient Pincode', 'Recipient City', 'Recipient State',
                    'Sender Name', 'Sender Pincode', 'Weight (kg)', 'Payment Mode',
                    'Carrier', 'Total Cost', 'Created At'
                ];

                // Build CSV rows
                const rows = orders.map(order => [
                    order.order_number || '',
                    order.status || '',
                    order.recipient_name || '',
                    order.recipient_contact || '',
                    order.recipient_pincode || '',
                    order.recipient_city || '',
                    order.recipient_state || '',
                    order.sender_name || '',
                    order.sender_pincode || '',
                    order.applicable_weight || order.weight || '',
                    order.payment_mode || '',
                    order.selected_carrier || '',
                    order.total_cost || '',
                    order.created_at ? new Date(order.created_at).toLocaleDateString() : ''
                ]);

                // Convert to CSV string
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(','))
                ].join('\n');

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `orders_export_${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                URL.revokeObjectURL(url);

                showToast(`Exported ${orders.length} orders to CSV`, 'success');
            } catch (error) {
                console.error('Export failed:', error);
                showToast('Failed to export orders', 'error');
            }
        }

        // Handle Order Selection
        function handleOrderSelection() {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            const selectedCount = checkboxes.length;
            const countSpan = document.getElementById('selected-count');
            const actionsDiv = document.getElementById('order-actions');

            // Buttons
            const editBtn = document.getElementById('edit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const deleteBtn = document.getElementById('delete-btn');
            const invoiceBtn = document.getElementById('invoice-btn');
            const trackBtn = document.getElementById('track-btn'); // New Track Button

            if (selectedCount > 0) {
                actionsDiv.classList.remove('hidden');
                countSpan.textContent = `${selectedCount} selected`;

                // Show/Hide buttons based on selection count
                deleteBtn.classList.remove('hidden');

                // Edit, Invoice, Track only for single selection
                if (selectedCount === 1) {
                    editBtn.classList.remove('hidden');
                    invoiceBtn.classList.remove('hidden');
                    if (trackBtn) trackBtn.classList.remove('hidden');
                } else {
                    editBtn.classList.add('hidden');
                    invoiceBtn.classList.add('hidden');
                    if (trackBtn) trackBtn.classList.add('hidden');
                }

                // Cancel allows multiple
                cancelBtn.classList.remove('hidden');
            } else {
                actionsDiv.classList.add('hidden');
            }
        }

        // Show Tracking Timeline
        async function showTrackingTimeline() {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            if (checkboxes.length !== 1) {
                showToast('Please select exactly one order to track', 'warning');
                return;
            }
            const orderId = checkboxes[0].value;
            const status = checkboxes[0].dataset.status;

            try {
                // Ideally fetch fresh order details, but we have ID and Status
                // Fetching fresh details also allows getting updated timestamps if we had them
                const response = await fetch(`${API_BASE}/api/orders/${orderId}/`);
                if (!response.ok) throw new Error('Failed to fetch order details');
                const order = await response.json();

                document.getElementById('track-order-number').textContent = order.order_number;
                const statusSpan = document.getElementById('track-order-status');
                statusSpan.textContent = order.status.toUpperCase();
                statusSpan.className = `text-sm font-medium px-2 py-1 rounded-full ${getStatusColor(order.status)}`;

                const timelineContainer = document.getElementById('tracking-timeline');
                timelineContainer.innerHTML = ''; // Clear previous

                // Define Steps
                const steps = [
                    { key: 'draft', label: 'Order Created', desc: 'Order details entered' },
                    { key: 'booked', label: 'Booked', desc: 'Carrier selected & booked' },
                    { key: 'picked_up', label: 'Picked Up', desc: 'Picked up by carrier' },
                    { key: 'in_transit', label: 'In Transit', desc: 'On the way to destination' },
                    { key: 'out_for_delivery', label: 'Out for Delivery', desc: 'Out for final delivery' },
                    { key: 'delivered', label: 'Delivered', desc: 'Successfully delivered' }
                ];

                // Determine current step index
                // Note: This logic assumes a linear flow. Cancelled/RTO need special handling.
                let currentIndex = -1;

                if (order.status === 'cancelled') {
                    // Special Case: Cancelled
                    timelineContainer.innerHTML = `
                        <div class="timeline-item pb-8">
                            <div class="timeline-dot error flex items-center justify-center">
                                <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                            </div>
                            <div class="timeline-content">
                                <h4>Order Cancelled</h4>
                                <p>This order has been cancelled.</p>
                                <p class="text-xs text-slate-400 mt-1">${new Date(order.updated_at).toLocaleString()}</p>
                            </div>
                        </div>
                    `;
                } else {
                    // Find index of current status
                    currentIndex = steps.findIndex(s => s.key === order.status);

                    // Fallback map for combined statuses
                    if (currentIndex === -1) {
                        if (order.status === 'manifested') currentIndex = 1; // Treat as Booked+
                        if (order.status === 'rto') currentIndex = 3; // Treat as In Transit (return)
                    }

                    // Render Steps
                    let html = '';
                    steps.forEach((step, index) => {
                        let dotClass = 'timeline-dot';
                        let isCompleted = index <= currentIndex;
                        let isCurrent = index === currentIndex;

                        if (isCurrent) {
                            dotClass += ' current';
                        } else if (isCompleted) {
                            dotClass += ' active';
                        }

                        // Checkmark for completed steps
                        let dotContent = '';
                        if (isCompleted && !isCurrent) {
                            dotContent = `<svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                        }

                        html += `
                            <div class="timeline-item ${index === steps.length - 1 ? '' : 'pb-8'}">
                                <div class="${dotClass}">${dotContent}</div>
                                <div class="timeline-content">
                                    <h4 class="${isCompleted ? 'text-slate-800' : 'text-slate-400'}">${step.label}</h4>
                                    <p class="${isCompleted ? 'text-slate-600' : 'text-slate-400'}">${step.desc}</p>
                                    ${isCurrent ? `<p class="text-xs text-brand-blue mt-1 font-medium">Current Status</p>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    timelineContainer.innerHTML = html;
                }

                document.getElementById('trackingModal').classList.remove('hidden');

            } catch (error) {
                console.error('Tracking error', error);
                showToast('Failed to load tracking info', 'error');
            }
        }

        function hideTrackingModal() {
            document.getElementById('trackingModal').classList.add('hidden');
        }

        // Download Invoice
        function downloadSelectedInvoice() {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            if (checkboxes.length !== 1) {
                showToast('Please select exactly one order to download invoice', 'warning');
                return;
            }

            const orderId = checkboxes[0].value;
            // Open in new tab
            window.open(`${API_BASE}/api/orders/${orderId}/invoice/`, '_blank');
        }


        // Load Shipment Orders
        async function loadShipmentOrders() {
            try {
                const response = await fetch(`${API_BASE}/api/orders/?status=draft`);
                const data = await response.json();
                // Handle both array and paginated response formats
                const draftOrders = Array.isArray(data) ? data : (data.results || []);

                const ordersHtml = draftOrders.map(order => `
                    <div class="bg-white border border-slate-200 rounded-lg p-4 hover:border-brand-blue cursor-pointer transition-all">
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" value="${order.id}" class="w-5 h-5 text-brand-blue border-slate-300 rounded focus:ring-brand-blue shipment-order-checkbox" onchange="handleShipmentOrderSelection()">
                            <div class="flex-1">
                                <div class="font-semibold text-slate-800">${order.order_number}</div>
                                <div class="text-sm text-slate-500">${order.recipient_name} - ${order.recipient_pincode}</div>
                                <div class="text-sm text-slate-600 mt-1">
                                    Weight: ${order.applicable_weight || order.weight} kg | ${order.payment_mode.toUpperCase()}
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('shipment-orders-list').innerHTML = ordersHtml || '<p class="text-slate-500 text-center py-4">No draft orders available</p>';
            } catch (error) {
                console.error('Failed to load shipment orders', error);
            }
        }

        // Handle Shipment Order Selection
        async function handleShipmentOrderSelection() {
            const checkboxes = document.querySelectorAll('.shipment-order-checkbox:checked');
            selectedOrdersForShipment = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (selectedOrdersForShipment.length > 0) {
                await compareCarriersForShipment();
            } else {
                document.getElementById('carrier-comparison').innerHTML = `
                    <div class="text-center py-12 text-slate-500">
                        <svg class="w-16 h-16 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p>Select orders to compare carrier rates</p>
                    </div>
                `;
            }
        }

        // Compare Carriers for Shipment
        async function compareCarriersForShipment() {
            try {
                const response = await fetch(`${API_BASE}/api/orders/compare-carriers/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_ids: selectedOrdersForShipment })
                });

                const data = await response.json();

                const carriersHtml = data.carriers.map(carrier => `
                    <label class="flex items-center p-3 border-b border-slate-100 hover:bg-slate-50 cursor-pointer rounded-lg transition-colors">
                        <input type="radio" name="selected-carrier" value='${JSON.stringify({ carrier: carrier.carrier, mode: carrier.mode })}' class="w-4 h-4 text-brand-blue border-slate-300 focus:ring-brand-blue">
                        <div class="ml-3 flex-1 flex items-center justify-between">
                            <div>
                                <div class="font-semibold text-slate-800">${carrier.carrier}</div>
                                <div class="text-xs text-slate-500">${carrier.mode} • ${carrier.applied_zone}</div>
                            </div>
                            <div class="text-right">
                                <div class="font-bold text-slate-800">₹${carrier.total_cost.toFixed(2)}</div>
                            </div>
                        </div>
                    </label>
                `).join('');

                document.getElementById('carrier-comparison').innerHTML = `
                    <div class="mb-3">
                        <div class="text-sm text-slate-600 mb-2">
                            <strong>${data.orders.length}</strong> order(s) selected | Total Weight: <strong>${data.total_weight} kg</strong>
                        </div>
                    </div>
                    <div class="space-y-2 mb-4">
                        ${carriersHtml}
                    </div>
                    <button onclick="bookSelectedCarrier()" class="w-full bg-brand-blue text-white py-3 rounded-lg hover:bg-blue-900 transition-colors font-medium">
                        Book Selected Carrier
                    </button>
                `;
            } catch (error) {
                showToast('Failed to compare carriers', 'error');
            }
        }

        // Book Selected Carrier
        async function bookSelectedCarrier() {
            const selected = document.querySelector('input[name="selected-carrier"]:checked');
            if (!selected) {
                showToast('Please select a carrier', 'warning');
                return;
            }

            const { carrier, mode } = JSON.parse(selected.value);

            try {
                const response = await fetch(`${API_BASE}/api/orders/book-carrier/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_ids: selectedOrdersForShipment,
                        carrier_name: carrier,
                        mode: mode
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(`Success! ${result.message}\nTotal Cost: ₹${result.total_cost}`);
                    selectedOrdersForShipment = [];
                    loadShipmentOrders();
                    loadDashboard();
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (error) {
                showToast('Failed to book carrier', 'error');
            }
        }

        // Order Selection Handling
        let selectedOrders = [];

        function handleOrderSelection() {
            const checkboxes = document.querySelectorAll('.order-checkbox:checked');
            selectedOrders = Array.from(checkboxes).map(cb => ({
                id: parseInt(cb.value),
                status: cb.dataset.status
            }));

            const actionsDiv = document.getElementById('order-actions');
            const selectedCount = document.getElementById('selected-count');
            const editBtn = document.getElementById('edit-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const deleteBtn = document.getElementById('delete-btn');

            if (selectedOrders.length > 0) {
                actionsDiv.classList.remove('hidden');
                selectedCount.textContent = `${selectedOrders.length} selected`;

                // Show Edit only if exactly 1 order selected and it's DRAFT
                if (selectedOrders.length === 1 && selectedOrders[0].status === 'draft') {
                    editBtn.classList.remove('hidden');
                } else {
                    editBtn.classList.add('hidden');
                }

                // Show Cancel only if all selected orders are BOOKED
                const allBooked = selectedOrders.every(o => o.status === 'booked');
                if (allBooked) {
                    cancelBtn.classList.remove('hidden');
                } else {
                    cancelBtn.classList.add('hidden');
                }

                // Show Delete only if all selected orders are DRAFT or CANCELLED
                const canDelete = selectedOrders.every(o => o.status === 'draft' || o.status === 'cancelled');
                if (canDelete) {
                    deleteBtn.classList.remove('hidden');
                } else {
                    deleteBtn.classList.add('hidden');
                }
            } else {
                actionsDiv.classList.add('hidden');
            }
        }

        async function editSelectedOrder() {
            if (selectedOrders.length !== 1) return;

            const orderId = selectedOrders[0].id;
            try {
                const response = await fetch(`${API_BASE}/api/orders/${orderId}/`);

                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error loading order: ${error.detail || 'Unknown error'}`);
                    return;
                }

                const order = await response.json();

                const form = document.getElementById('createOrderForm');

                // Populate the edit form with existing data using name selectors
                form.querySelector('[name="recipient_name"]').value = order.recipient_name || '';
                form.querySelector('[name="recipient_contact"]').value = order.recipient_contact || '';
                form.querySelector('[name="recipient_address"]').value = order.recipient_address || '';
                form.querySelector('[name="recipient_pincode"]').value = order.recipient_pincode || '';
                form.querySelector('[name="recipient_city"]').value = order.recipient_city || '';
                form.querySelector('[name="recipient_state"]').value = order.recipient_state || '';
                form.querySelector('[name="recipient_email"]').value = order.recipient_email || '';

                form.querySelector('[name="sender_pincode"]').value = order.sender_pincode || '';
                form.querySelector('[name="sender_name"]').value = order.sender_name || '';
                form.querySelector('[name="sender_address"]').value = order.sender_address || '';
                form.querySelector('[name="sender_phone"]').value = order.sender_phone || '';

                form.querySelector('[name="weight"]').value = order.weight || '';
                form.querySelector('[name="length"]').value = order.length || '';
                form.querySelector('[name="width"]').value = order.width || '';
                form.querySelector('[name="height"]').value = order.height || '';

                form.querySelector('[name="payment_mode"]').value = order.payment_mode || 'prepaid';
                form.querySelector('[name="order_value"]').value = order.order_value || '0';
                form.querySelector('[name="item_type"]').value = order.item_type || '';
                form.querySelector('[name="sku"]').value = order.sku || '';
                form.querySelector('[name="quantity"]').value = order.quantity || '1';
                form.querySelector('[name="item_amount"]').value = order.item_amount || '0';
                form.querySelector('[name="notes"]').value = order.notes || '';

                // Show COD details if applicable
                if (order.payment_mode === 'cod') {
                    const codDetails = document.getElementById('cod-details');
                    if (codDetails) codDetails.classList.remove('hidden');
                }

                // Calculate and display weights
                calculateWeights();

                // Store order ID for update
                form.dataset.editId = orderId;
                const modalTitle = document.getElementById('modal-title');
                const submitBtn = document.getElementById('submit-order-btn');
                if (modalTitle) modalTitle.textContent = 'Edit Order';
                if (submitBtn) submitBtn.textContent = 'Update Order';

                showCreateOrderModal();
            } catch (error) {
                console.error('Edit error:', error);
                alert('Failed to load order details: ' + error.message);
            }
        }

        async function cancelSelectedOrders() {
            if (!confirm(`Are you sure you want to cancel ${selectedOrders.length} order(s)?`)) return;

            try {
                const promises = selectedOrders.map(order =>
                    fetch(`${API_BASE}/api/orders/${order.id}/cancel/`, { method: 'POST' })
                );

                await Promise.all(promises);
                showToast('Orders cancelled successfully!', 'success');

                // Clear selection
                selectedOrders = [];
                loadAllOrders();
                loadDashboard();
            } catch (error) {
                showToast('Failed to cancel orders', 'error');
            }
        }

        async function deleteSelectedOrders() {
            if (!confirm(`Are you sure you want to delete ${selectedOrders.length} order(s)? This cannot be undone.`)) return;

            try {
                const promises = selectedOrders.map(order =>
                    fetch(`${API_BASE}/api/orders/${order.id}/`, { method: 'DELETE' })
                );

                await Promise.all(promises);
                showToast('Orders deleted successfully!', 'success');

                // Clear selection
                selectedOrders = [];
                loadAllOrders();
                loadDashboard();
            } catch (error) {
                showToast('Failed to delete orders', 'error');
            }
        }

        // Helper Functions
        function getStatusColor(status) {
            const colors = {
                draft: 'bg-yellow-100 text-yellow-700',
                pending: 'bg-orange-100 text-orange-700',
                booked: 'bg-green-100 text-green-700',
                manifested: 'bg-indigo-100 text-indigo-700',
                picked_up: 'bg-blue-100 text-blue-700',
                out_for_delivery: 'bg-purple-100 text-purple-700',
                in_transit: 'bg-blue-100 text-blue-700',
                delivered: 'bg-green-100 text-green-700',
                cancelled: 'bg-red-100 text-red-700',
                pickup_exception: 'bg-orange-100 text-orange-700',
                ndr: 'bg-pink-100 text-pink-700',
                rto: 'bg-red-100 text-red-700'
            };
            return colors[status] || 'bg-slate-100 text-slate-700';
        }

        // ============================================================================
        // FTL FUNCTIONALITY
        // ============================================================================

        let ftlRatesData = {};
        let selectedFTLOrders = [];

        // Load FTL routes from backend API
        async function loadFTLRatesData() {
            try {
                const response = await fetch(`${API_BASE}/api/ftl/routes`);
                if (response.ok) {
                    ftlRatesData = await response.json();

                    // Update source city dropdown if it exists
                    const sourceCitySelect = document.getElementById('ftl-source-city');
                    if (sourceCitySelect) {
                        // Clear existing options except the first one
                        sourceCitySelect.innerHTML = '<option value="">Select Source City</option>';

                        // Add all source cities
                        Object.keys(ftlRatesData).forEach(city => {
                            const option = document.createElement('option');
                            option.value = city;
                            option.textContent = city;
                            sourceCitySelect.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to load FTL rates:', error);
            }
        }

        // Update destination cities based on source city selection
        function updateFTLDestinations() {
            const sourceCity = document.getElementById('ftl-source-city').value;
            const destSelect = document.getElementById('ftl-destination-city');

            destSelect.innerHTML = '<option value="">Select Destination City</option>';

            if (sourceCity && ftlRatesData[sourceCity]) {
                const destinations = ftlRatesData[sourceCity];
                destinations.forEach(dest => {
                    const option = document.createElement('option');
                    option.value = dest;
                    option.textContent = dest;
                    destSelect.appendChild(option);
                });
            }

            // Clear pricing when source changes
            document.getElementById('ftl-pricing-breakdown').classList.add('hidden');
        }

        // Calculate FTL rate
        async function calculateFTLRate() {
            const sourceCity = document.getElementById('ftl-source-city').value;
            const destCity = document.getElementById('ftl-destination-city').value;
            const containerType = document.getElementById('ftl-container-type').value;

            if (!sourceCity || !destCity || !containerType) {
                document.getElementById('ftl-pricing-breakdown').classList.add('hidden');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/ftl/calculate-rate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_city: sourceCity,
                        destination_city: destCity,
                        container_type: containerType
                    })
                });

                if (response.ok) {
                    const pricing = await response.json();

                    document.getElementById('ftl-base-price').textContent = `₹${pricing.base_price.toFixed(2)}`;
                    document.getElementById('ftl-escalation').textContent = `₹${pricing.escalation_amount.toFixed(2)}`;
                    document.getElementById('ftl-price-escalation').textContent = `₹${pricing.price_with_escalation.toFixed(2)}`;
                    document.getElementById('ftl-gst').textContent = `₹${pricing.gst_amount.toFixed(2)}`;
                    document.getElementById('ftl-total-price').textContent = `₹${pricing.total_price.toFixed(2)}`;

                    document.getElementById('ftl-pricing-breakdown').classList.remove('hidden');
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                    document.getElementById('ftl-pricing-breakdown').classList.add('hidden');
                }
            } catch (error) {
                console.error('Failed to calculate FTL rate:', error);
                showToast('Failed to calculate rate', 'error');
            }
        }

        // Show/Hide FTL Modal
        function showCreateFTLModal() {
            document.getElementById('createFTLModal').classList.remove('hidden');
            loadFTLRatesData();
        }

        function hideCreateFTLModal() {
            document.getElementById('createFTLModal').classList.add('hidden');
            const form = document.getElementById('createFTLForm');
            form.reset();
            delete form.dataset.editId;
            document.getElementById('ftl-modal-title').textContent = 'Create FTL Order';
            document.getElementById('submit-ftl-btn').textContent = 'Create FTL Order';
            document.getElementById('ftl-pricing-breakdown').classList.add('hidden');
        }

        // Create/Update FTL Order
        document.getElementById('createFTLForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {};

            formData.forEach((value, key) => {
                if (value !== '') {
                    if (['source_pincode', 'destination_pincode'].includes(key)) {
                        data[key] = parseInt(value);
                    } else {
                        data[key] = value;
                    }
                }
            });

            try {
                const editId = e.target.dataset.editId;
                const isEdit = editId !== undefined && editId !== '';

                const url = isEdit ? `${API_BASE}/api/ftl-orders/${editId}/` : `${API_BASE}/api/ftl-orders/`;
                const method = isEdit ? 'PATCH' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert(isEdit ? 'FTL Order updated successfully!' : 'FTL Order created successfully!');
                    hideCreateFTLModal();
                    loadFTLOrders();
                    // Also reload shipment FTL orders if that tab is visible
                    if (!document.getElementById('shipment-ftl-tab').classList.contains('hidden')) {
                        loadShipmentFTLOrders();
                    }
                } else {
                    const error = await response.json();
                    let errorMessage = '';

                    if (error.detail) {
                        errorMessage = typeof error.detail === 'string' ? error.detail : JSON.stringify(error.detail);
                    } else {
                        // Handle field-specific validation errors
                        const errors = [];
                        for (const [field, messages] of Object.entries(error)) {
                            const fieldName = field.charAt(0).toUpperCase() + field.slice(1).replace('_', ' ');
                            const message = Array.isArray(messages) ? messages.join(', ') : messages;
                            errors.push(`${fieldName}: ${message}`);
                        }
                        errorMessage = errors.join('\n');
                    }

                    alert(`Error:\n${errorMessage}`);
                }
            } catch (error) {
                console.error('FTL order creation error:', error);
                alert('Failed to create FTL order: ' + error.message);
            }
        });

        // Load FTL Orders
        async function loadFTLOrders(status = null) {
            try {
                const url = status && status !== 'all' ? `${API_BASE}/api/ftl-orders/?status=${status}` : `${API_BASE}/api/ftl-orders/`;
                const response = await fetch(url);
                const data = await response.json();
                // Handle both array and paginated response formats
                const orders = Array.isArray(data) ? data : (data.results || []);

                const ordersHtml = orders.map(order => `
                    <div class="bg-white border border-slate-200 rounded-lg p-4 hover:border-brand-blue transition-all relative">
                        <div class="absolute top-3 left-3">
                            <input type="checkbox" value="${order.id}" data-status="${order.status}" class="w-5 h-5 text-brand-blue border-slate-300 rounded focus:ring-brand-blue ftl-order-checkbox" onchange="handleFTLOrderSelection()">
                        </div>
                        <div class="pl-8">
                            <div class="flex items-start justify-between mb-3">
                                <span class="text-sm font-medium text-slate-500">${order.order_number}</span>
                                <span class="text-xs px-2 py-1 rounded-full ${getStatusColor(order.status)}">${order.status.toUpperCase()}</span>
                            </div>
                            <h4 class="font-semibold text-slate-800 mb-2">${order.name}</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                                <div class="col-span-2">
                                    <span class="text-slate-500">Route:</span>
                                    <span class="ml-1 font-medium text-slate-700">${order.source_city} → ${order.destination_city}</span>
                                </div>
                                <div>
                                    <span class="text-slate-500">Container:</span>
                                    <span class="ml-1 font-medium text-slate-700">${order.container_type}</span>
                                </div>
                                <div>
                                    <span class="text-slate-500">Total:</span>
                                    <span class="ml-1 font-medium text-brand-blue">₹${parseFloat(order.total_price).toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('ftl-orders-list').innerHTML = ordersHtml || '<p class="text-slate-500 col-span-full text-center py-8">No FTL orders found</p>';
            } catch (error) {
                console.error('Failed to load FTL orders', error);
            }
        }

        // Filter FTL Orders
        function filterFTLOrders(status) {
            document.querySelectorAll('.ftl-filter-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-brand-blue', 'shadow-sm');
                btn.classList.add('text-slate-600');
                if (btn.dataset.filter === status) {
                    btn.classList.remove('text-slate-600');
                    btn.classList.add('bg-white', 'text-brand-blue', 'shadow-sm');
                }
            });
            loadFTLOrders(status);
        }

        // Handle FTL Order Selection
        function handleFTLOrderSelection() {
            const checkboxes = document.querySelectorAll('.ftl-order-checkbox:checked');
            selectedFTLOrders = Array.from(checkboxes).map(cb => ({
                id: parseInt(cb.value),
                status: cb.dataset.status
            }));

            const actionsDiv = document.getElementById('ftl-order-actions');
            const selectedCount = document.getElementById('ftl-selected-count');
            const editBtn = document.getElementById('ftl-edit-btn');
            const deleteBtn = document.getElementById('ftl-delete-btn');

            if (selectedFTLOrders.length > 0) {
                actionsDiv.classList.remove('hidden');
                selectedCount.textContent = `${selectedFTLOrders.length} selected`;

                // Show Edit only if exactly 1 order selected and it's DRAFT
                if (selectedFTLOrders.length === 1 && selectedFTLOrders[0].status === 'draft') {
                    editBtn.classList.remove('hidden');
                } else {
                    editBtn.classList.add('hidden');
                }

                // Show Delete only if all selected orders are DRAFT or CANCELLED
                const canDelete = selectedFTLOrders.every(o => o.status === 'draft' || o.status === 'cancelled');
                if (canDelete) {
                    deleteBtn.classList.remove('hidden');
                } else {
                    deleteBtn.classList.add('hidden');
                }
            } else {
                actionsDiv.classList.add('hidden');
            }
        }

        // Edit FTL Order
        async function editSelectedFTLOrder() {
            if (selectedFTLOrders.length !== 1) return;

            const orderId = selectedFTLOrders[0].id;
            try {
                const response = await fetch(`${API_BASE}/api/ftl-orders/${orderId}/`);

                if (!response.ok) {
                    const error = await response.json();
                    alert(`Error loading order: ${error.detail || 'Unknown error'}`);
                    return;
                }

                const order = await response.json();
                const form = document.getElementById('createFTLForm');

                // Populate form
                form.querySelector('[name="name"]').value = order.name || '';
                form.querySelector('[name="email"]').value = order.email || '';
                form.querySelector('[name="phone"]').value = order.phone || '';
                form.querySelector('[name="source_city"]').value = order.source_city || '';

                // Load destinations and set destination city
                await loadFTLRatesData();
                updateFTLDestinations();
                form.querySelector('[name="destination_city"]').value = order.destination_city || '';

                form.querySelector('[name="source_pincode"]').value = order.source_pincode || '';
                form.querySelector('[name="destination_pincode"]').value = order.destination_pincode || '';
                form.querySelector('[name="container_type"]').value = order.container_type || '';
                form.querySelector('[name="notes"]').value = order.notes || '';

                // Calculate and show pricing
                await calculateFTLRate();

                // Set edit mode
                form.dataset.editId = orderId;
                document.getElementById('ftl-modal-title').textContent = 'Edit FTL Order';
                document.getElementById('submit-ftl-btn').textContent = 'Update FTL Order';

                showCreateFTLModal();
            } catch (error) {
                console.error('Edit error:', error);
                alert('Failed to load FTL order details: ' + error.message);
            }
        }

        // Delete FTL Orders
        async function deleteSelectedFTLOrders() {
            if (!confirm(`Are you sure you want to delete ${selectedFTLOrders.length} FTL order(s)? This cannot be undone.`)) return;

            try {
                const promises = selectedFTLOrders.map(order =>
                    fetch(`${API_BASE}/api/ftl-orders/${order.id}/`, { method: 'DELETE' })
                );

                await Promise.all(promises);
                showToast('FTL orders deleted successfully!', 'success');

                selectedFTLOrders = [];
                loadFTLOrders();
            } catch (error) {
                showToast('Failed to delete FTL orders', 'error');
            }
        }

        // Shipment Tab Switching
        function showShipmentTab(tab) {
            document.querySelectorAll('.shipment-tab-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-brand-blue', 'shadow-sm');
                btn.classList.add('text-slate-600');
                if (btn.dataset.tab === tab) {
                    btn.classList.remove('text-slate-600');
                    btn.classList.add('bg-white', 'text-brand-blue', 'shadow-sm');
                }
            });

            document.querySelectorAll('.shipment-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            if (tab === 'regular') {
                document.getElementById('shipment-regular-tab').classList.remove('hidden');
                loadShipmentOrders();
            } else if (tab === 'ftl') {
                document.getElementById('shipment-ftl-tab').classList.remove('hidden');
                loadShipmentFTLOrders();
            }
        }

        // Load FTL Orders in Shipment Section
        async function loadShipmentFTLOrders() {
            try {
                // Load all FTL orders (not just booked)
                const response = await fetch(`${API_BASE}/api/ftl-orders/`);
                const data = await response.json();
                // Handle both array and paginated response formats
                const orders = Array.isArray(data) ? data : (data.results || []);

                const ordersHtml = orders.map(order => `
                    <div class="bg-white border border-slate-200 rounded-lg p-4 hover:border-brand-blue transition-all relative">
                        <div class="absolute top-3 left-3">
                            <input type="checkbox" value="${order.id}" data-status="${order.status}" class="w-5 h-5 text-brand-blue border-slate-300 rounded focus:ring-brand-blue shipment-ftl-order-checkbox" onchange="handleShipmentFTLOrderSelection()">
                        </div>
                        <div class="pl-8">
                            <div class="flex items-start justify-between mb-3">
                                <span class="text-sm font-medium text-slate-500">${order.order_number}</span>
                                <span class="text-xs px-2 py-1 rounded-full ${getStatusColor(order.status)}">${order.status.toUpperCase()}</span>
                            </div>
                            <h4 class="font-semibold text-slate-800 mb-2">${order.name}</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                                <div class="col-span-2">
                                    <span class="text-slate-500">Route:</span>
                                    <span class="ml-1 font-medium text-slate-700">${order.source_city} → ${order.destination_city}</span>
                                </div>
                                <div class="col-span-2">
                                    <span class="text-slate-500">Source Address:</span>
                                    <span class="ml-1 text-slate-700">${order.source_address}</span>
                                </div>
                                <div>
                                    <span class="text-slate-500">Container:</span>
                                    <span class="ml-1 font-medium text-slate-700">${order.container_type}</span>
                                </div>
                                <div>
                                    <span class="text-slate-500">Total:</span>
                                    <span class="ml-1 font-medium text-brand-blue">₹${parseFloat(order.total_price).toFixed(2)}</span>
                                </div>
                                ${order.email ? `<div class="col-span-2">
                                    <span class="text-slate-500">Email:</span>
                                    <span class="ml-1 text-slate-700">${order.email}</span>
                                </div>` : ''}
                                <div class="col-span-2">
                                    <span class="text-slate-500">Phone:</span>
                                    <span class="ml-1 text-slate-700">${order.phone}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');

                document.getElementById('shipment-ftl-orders-list').innerHTML = ordersHtml || '<p class="text-slate-500 col-span-full text-center py-8">No FTL orders</p>';
            } catch (error) {
                console.error('Failed to load shipment FTL orders', error);
            }
        }

        // Handle Shipment FTL Order Selection
        let selectedShipmentFTLOrders = [];
        function handleShipmentFTLOrderSelection() {
            const checkboxes = document.querySelectorAll('.shipment-ftl-order-checkbox:checked');
            selectedShipmentFTLOrders = Array.from(checkboxes).map(cb => ({
                id: parseInt(cb.value),
                status: cb.dataset.status
            }));

            const actionsDiv = document.getElementById('shipment-ftl-actions');
            const bookBtn = document.getElementById('shipment-ftl-book-btn');
            const editBtn = document.getElementById('shipment-ftl-edit-btn');
            const deleteBtn = document.getElementById('shipment-ftl-delete-btn');
            const countSpan = document.getElementById('shipment-ftl-selected-count');

            if (selectedShipmentFTLOrders.length > 0) {
                actionsDiv.classList.remove('hidden');
                countSpan.textContent = `${selectedShipmentFTLOrders.length} selected`;

                // Check if all selected orders are DRAFT
                const allDraft = selectedShipmentFTLOrders.every(order => order.status === 'draft');

                // Show book button only for DRAFT orders
                if (allDraft) {
                    bookBtn.classList.remove('hidden');
                } else {
                    bookBtn.classList.add('hidden');
                }

                // Show edit button only if one DRAFT order is selected
                if (selectedShipmentFTLOrders.length === 1 && allDraft) {
                    editBtn.classList.remove('hidden');
                } else {
                    editBtn.classList.add('hidden');
                }
            } else {
                actionsDiv.classList.add('hidden');
            }
        }

        // Edit Selected Shipment FTL Order
        async function editSelectedShipmentFTLOrder() {
            if (selectedShipmentFTLOrders.length !== 1) {
                alert('Please select exactly one order to edit');
                return;
            }

            const orderId = selectedShipmentFTLOrders[0].id;

            try {
                const response = await fetch(`${API_BASE}/api/ftl-orders/${orderId}/`);
                const order = await response.json();

                // Populate the form
                document.querySelector('#createFTLForm [name="name"]').value = order.name;
                document.querySelector('#createFTLForm [name="email"]').value = order.email || '';
                document.querySelector('#createFTLForm [name="phone"]').value = order.phone;
                document.querySelector('#createFTLForm [name="source_city"]').value = order.source_city;
                document.querySelector('#createFTLForm [name="source_address"]').value = order.source_address;
                document.querySelector('#createFTLForm [name="source_pincode"]').value = order.source_pincode;
                document.querySelector('#createFTLForm [name="destination_city"]').value = order.destination_city;
                document.querySelector('#createFTLForm [name="destination_pincode"]').value = order.destination_pincode;
                document.querySelector('#createFTLForm [name="container_type"]').value = order.container_type;

                // Update destinations and calculate rate
                await updateFTLDestinations();
                await calculateFTLRate();

                // Set edit mode
                document.getElementById('createFTLForm').dataset.editId = orderId;
                document.getElementById('ftl-modal-title').textContent = 'Edit FTL Order';
                document.getElementById('submit-ftl-btn').textContent = 'Update FTL Order';

                // Show modal
                showCreateFTLModal();
            } catch (error) {
                console.error('Failed to load FTL order for editing', error);
                alert('Failed to load order for editing');
            }
        }

        // Delete Selected Shipment FTL Orders
        async function deleteSelectedShipmentFTLOrders() {
            if (selectedShipmentFTLOrders.length === 0) {
                alert('Please select orders to delete');
                return;
            }

            if (!confirm(`Are you sure you want to delete ${selectedShipmentFTLOrders.length} order(s)?`)) {
                return;
            }

            try {
                const promises = selectedShipmentFTLOrders.map(order =>
                    fetch(`${API_BASE}/api/ftl-orders/${order.id}/`, { method: 'DELETE' })
                );

                await Promise.all(promises);
                showToast('FTL orders deleted successfully!', 'success');

                selectedShipmentFTLOrders = [];
                loadShipmentFTLOrders();
            } catch (error) {
                console.error('Failed to delete FTL orders', error);
                showToast('Failed to delete FTL orders', 'error');
            }
        }

        // Book Selected FTL Orders
        async function bookSelectedFTLOrders() {
            if (selectedShipmentFTLOrders.length === 0) {
                alert('Please select orders to book');
                return;
            }

            // Check if all selected orders are DRAFT
            const nonDraftOrders = selectedShipmentFTLOrders.filter(order => order.status !== 'draft');
            if (nonDraftOrders.length > 0) {
                alert('Only DRAFT orders can be booked. Please select only DRAFT orders.');
                return;
            }

            if (!confirm(`Are you sure you want to book ${selectedShipmentFTLOrders.length} FTL order(s)?`)) {
                return;
            }

            try {
                const orderIds = selectedShipmentFTLOrders.map(order => order.id);

                const response = await fetch(`${API_BASE}/api/ftl-orders/book/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ order_ids: orderIds })
                });

                if (response.ok) {
                    const result = await response.json();
                    alert(result.message || 'FTL orders booked successfully!');
                    selectedShipmentFTLOrders = [];
                    loadShipmentFTLOrders();
                    loadFTLOrders(); // Also refresh the main FTL orders list
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail || 'Failed to book orders'}`);
                }
            } catch (error) {
                console.error('Failed to book FTL orders', error);
                alert('Failed to book FTL orders: ' + error.message);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadDashboard();
            loadFTLRatesData();
        });
    </script>
</body>

</html>